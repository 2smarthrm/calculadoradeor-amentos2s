<!---
 
-->
<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2smart | Calculadora de orçamentos</title>

  <!-- Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Fav Icon -->
    <link rel="icon" href="https://2smart.pt/assets/images//2Smart.png" type="image/x-icon">
  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- html2pdf (html2canvas + jsPDF) -->
  
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --b0:#061735;
      --b1:#0b2e7a;
      --b2:#0b5cff;
      --b3:#7aa7ff;
      --card:#0b1c3a;
      --ink:#0d1b2a;
      --muted:#6b7a90;
      --line:#e9eef6;
      --soft:#f6f8fc;
    }

    *{ box-sizing:border-box; }
 body {
  font-family: "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: #0b1220;

  background:
    radial-gradient(900px 600px at 15% 20%, rgba(0, 102, 255, 0.45), transparent 60%),
    radial-gradient(800px 500px at 85% 25%, rgba(120, 170, 255, 0.45), transparent 55%),
    radial-gradient(1000px 700px at 50% 90%, rgba(10, 40, 120, 0.55), transparent 65%),
    linear-gradient(180deg, #eaf1ff 0%, #cddcff 40%, #4b78ff 100%);

  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}


    .shell{
      padding: 28px 0 50px;
    }

    .app-card{
      background: rgba(255,255,255,.90);
      border: 1px solid rgba(255,255,255,.25);
      border-radius: 22px;
      box-shadow: 0 25px 70px rgba(0,0,0,.25);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      padding: 18px 22px;
      background: linear-gradient(90deg, rgba(11,92,255,.10), rgba(122,167,255,.12));
      border-bottom: 1px solid rgba(13,27,42,.08);
    }

    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand img{
      height: 28px; width:auto;
    }
    .brand .title{
      line-height: 1.1;
    }
    .brand .title b{
      display:block; font-size: 14px;
    }
    .brand .title span{
      display:block; font-size: 12px; color: var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(11,92,255,.10);
      border: 1px solid rgba(11,92,255,.18);
      color: #0b2e7a;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
    }

    .grid{
      display:flex; 
      justify-content: center;
      align-items: center;
      height:100%;
      width:100%; 
      gap: 16px;
      padding: 18px 22px 22px;
    }
    @media (max-width: 992px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: #fff;
      border: 1px solid rgba(13,27,42,.08);
      border-radius: 18px;
      padding: 16px;
    }

    .panel h5{
      font-weight: 800;
      font-size: 14px;
      margin: 0 0 10px;
      letter-spacing: .2px;
    }

    .section-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 10px 0 8px;
    }

    .section-head .left{
      display:flex; align-items:center; gap:10px;
      font-weight: 800;
      color: #0b2e7a;
      font-size: 13px;
    }
    .section-head .left .badge-num{
      width: 28px; height: 28px; border-radius: 999px;
      display:grid; place-items:center;
      border: 2px solid rgba(11,92,255,.45);
      color: #0b5cff;
      font-weight: 800;
      font-size: 12px;
      background: rgba(11,92,255,.06);
    }

    .mini-actions{
      display:flex; gap: 8px; flex-wrap: wrap;
    }

    .soft{
      background: var(--soft);
      border: 1px solid rgba(13,27,42,.08);
      border-radius: 14px;
      padding: 12px;
    }

    .form-label{
      font-size: 12px;
      font-weight: 700;
      color: #294a86;
    }

    .table-lite{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(13,27,42,.08);
    }

    .table-lite th, .table-lite td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(13,27,42,.06);
      font-size: 12px;
      vertical-align: middle;
    }
    .table-lite thead th{
      background: linear-gradient(90deg, rgba(11,92,255,.12), rgba(122,167,255,.10));
      font-weight: 800;
      color: #0b2e7a;
      border-bottom: 1px solid rgba(13,27,42,.08);
    }
    .table-lite tr:last-child td{ border-bottom: 0; }
    .table-lite td .muted{ color: var(--muted); font-weight: 600; font-size: 11px; }

    .btn-ghost{
      border: 1px solid rgba(13,27,42,.12);
      background: #fff;
    }
    .btn-ghost:hover{ background: rgba(11,92,255,.05); border-color: rgba(11,92,255,.22); }

    .totals-card{
      background: linear-gradient(160deg, rgba(11,92,255,.12), rgba(122,167,255,.08));
      border: 1px solid rgba(11,92,255,.18);
      border-radius: 18px;
      padding: 14px;
    }
    .totals-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(13,27,42,.08);
      margin-bottom: 10px;
    }
    .totals-row:last-child{ margin-bottom:0; }
    .totals-row .k{
      font-weight: 800;
      color:#0b2e7a;
      font-size: 12px;
    }
    .totals-row .v{
      font-weight: 900;
      font-size: 14px;
    }

    .sticky-actions{
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.92);
      border-top: 1px solid rgba(13,27,42,.08);
      padding: 14px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 768px){
      .sticky-actions{ flex-direction: column; align-items: stretch; }
    }

    .loader{
      display:none;
      align-items:center;
      gap:10px;
      font-weight:700;
      color:#0b2e7a;
      font-size: 12px;
    }
    .loader.show{ display:flex; }
    .spinner{
      width: 18px; height:18px;
      border-radius: 999px;
      border: 3px solid rgba(11,92,255,.25);
      border-top-color: rgba(11,92,255,.95);
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* PDF area (hidden) */
    #pdfRoot{
      width: 794px; /* ~A4 @ 96dpi */
      background:#fff;
      color:#0d1b2a;
      font-family:"Montserrat", Arial, sans-serif;
    }
        .pdf-page{
      width: 794px; /* ~A4 @ 96dpi */
      background:#fff;
    }
    /* Full-bleed pages (capa e última página) */
    .pdf-bleed{
      width: 794px;
      height: 1123px;
      position: relative;
      page-break-after: always;
      overflow: hidden;
      background:#fff;
    }
    .pdf-bleed img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    /* Content flow (pode paginar automaticamente) */
    .pdf-flow{
      width: 794px;
      background:#fff;
      page-break-after: always;
    }

    @page { margin: 0; }
    #pdfRoot, #pdfRoot *{
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .pdf-meta{
      margin: 0 36px 14px;
      padding: 14px 14px;
      border: 1px solid #e6eefb;
      border-radius: 14px;
      background: #f7fbff;
    }
    .pdf-meta-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 18px;
      font-size: 11px;
      color:#30425e;
      font-weight: 600;
      line-height: 1.45;
    }
    .pdf-meta-item b{
      display:block;
      font-size: 10px;
      letter-spacing: .2px;
      color:#0b2e7a;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .pdf-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      padding: 24px 36px 10px;
    }
    .pdf-header .meta h2{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      color:#0b2e7a;
    }
    .pdf-header .meta p{
      margin:6px 0 0;
      font-size: 12px;
      color:#51627c;
      font-weight: 600;
    }
    .pdf-header .logo{
      height: 34px;
    }
    .pdf-block{
      padding: 0 36px 14px;
    }
    .pdf-section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 14px 0 8px;
      font-weight: 900;
      color:#0b2e7a;
      font-size: 13px;
    }
    .pdf-table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid #e8eef7;
      border-radius: 12px;
      overflow:hidden;
    }
    .pdf-table th, .pdf-table td{
      font-size: 11px;
      padding: 10px 10px;
      border-bottom: 1px solid #eef3fb;
      vertical-align: top;
    }
    .pdf-table thead th{
      background: #eef5ff;
      color:#0b2e7a;
      font-weight: 900;
      border-bottom: 1px solid #e0e9f8;
    }
    .pdf-table tr:last-child td{ border-bottom:0; }
    .pdf-table td:last-child, .pdf-table th:last-child{ text-align:right; }
    .pdf-table td:nth-child(2), .pdf-table th:nth-child(2){ text-align:center; width: 80px; }
    .pdf-table td:nth-child(3), .pdf-table th:nth-child(3){ text-align:right; width: 140px; }
    .pdf-note{
      font-size: 10px;
      color:#5a6c87;
      margin-top: 8px;
      font-weight: 600;
    }
    .pdf-totals{
      display:flex;
      gap:10px;
      padding: 12px 36px 0;
      flex-wrap: wrap;
    }
    .pdf-chip{
      border: 1px solid #e0e9f8;
      background: #f7faff;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 900;
      color:#0b2e7a;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pdf-chip span{
      color:#0d1b2a;
      font-weight: 900;
    }
    .pdf-footer{
      position:absolute;
      left:0; right:0;
      bottom:0;
    }
    .pdf-footer-overlay{
      position:absolute;
      left:0; right:0;
      bottom: 16px;
      padding: 0 36px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      pointer-events:none;
      color:#ffffff;
    }
    .pdf-footer-overlay .who{
      font-size: 12px;
      font-weight: 800;
      text-shadow: 0 2px 12px rgba(0,0,0,.25);
    }
    .pdf-footer-overlay .who small{
      display:block;
      font-size: 10px;
      font-weight: 600;
      opacity:.95;
    }
  
    /* ===== PDF Export (A4, sem margens, sem páginas em branco) ===== */
    @page { margin: 0; }
    html, body { margin:0; padding:0; }

    /* Host para captura: coordenadas POSITIVAS (evita "página na negativa") */
    #pdfRenderHost{
      position: fixed;
      left: 0;
      top: 0;
      width: 794px;
      height: 1123px;
      opacity: 0.01;
      z-index: -1;
      pointer-events: none;
    }

    #pdfRoot{
      width: 794px;
      margin: 0 !important;
      padding: 0 !important;
      background:#fff;
      color:#0d1b2a;
      font-family:"Montserrat", Arial, sans-serif;
    }

    /* Capa / Footer: 1 página inteira */
    .pdf-cover,
    .pdf-footer{
      width: 794px;
      height: 1123px;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden;
      background:#fff;
      position: relative;
    }
    .pdf-cover{ page-break-after: always; }
    .pdf-footer{ page-break-before: always; page-break-after: auto; }

    .pdf-cover img,
    .pdf-footer img{
      width: 100%;
      height: 100%;
      display:block;
      object-fit: cover; /* ocupa a folha inteira */
    }

    /* Conteúdo: começa no topo e evita cortes estranhos */
    .pdf-flow{
      width: 794px;
      margin: 0 !important;
      padding: 0 !important;
      background:#fff;
    }
    .pdf-header, .pdf-meta, .pdf-totals { break-inside: avoid; page-break-inside: avoid; }
    .pdf-table tr{ break-inside: avoid; page-break-inside: avoid; }
    .pdf-table th, .pdf-table td{
      word-break: break-word;
      overflow-wrap: anywhere;
      hyphens: auto;
    }

    /* Preview modal mais estreito */
    .modal-dialog.modal-preview-narrow{
      max-width: 920px;
    }

</style>
</head>

<body>
  <div class="container shell">
    <div class="app-card">

      <div class="topbar">
        <div class="brand">
          <img id="brandLogo" alt="2smart" src="https://ik.imagekit.io/fsobpyaa5i/Ativo%208%20(2).png">
          <div class="title">
            <b>Calculadora de orçamentos</b> 
          </div>
        </div>
 
      </div>

      <div class="grid col-lg-12">
        <!-- LEFT: Form -->
        <div class="panel col-lg-12">
          <h5>Dados da Proposta</h5>

          <div class="row g-3">
            <div class="col-md-7">
              <label class="form-label">Nome do Projecto</label>
              <input id="projectName" class="form-control" placeholder="Ex: Implementação 2smart HR" value="Projeto para cliente">
            </div>
            <div class="col-md-5">
              <label class="form-label">Referência</label>
              <input id="refCode" class="form-control" placeholder="Ex: 4989487984" value="">
            </div>

            <div class="col-md-6">
              <label class="form-label">Cliente</label>
              <input id="clientName" class="form-control" placeholder="Nome do cliente" value="">
            </div>
            <div class="col-md-6">
              <label class="form-label">Validade da proposta</label>
              <input id="validity" class="form-control" placeholder="Ex: 30 dias" value="30 dias">
            </div>

            <div class="col-md-4">
              <label class="form-label">Comercial</label>
              <input id="salesName" class="form-control" placeholder="Nome do comercial" value="Miguel Cunha">
            </div>
            <div class="col-md-4">
              <label class="form-label">Função</label>
              <input id="salesRole" class="form-control" placeholder="Ex: Account Manager" value="Account Manager">
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input id="salesEmail" class="form-control" placeholder="email@2smart.pt" value="sales@2smart.pt">
            </div>
          </div>

          <hr class="my-4">

          <!-- Section toggles -->
          <div class="soft">
            <div class="d-flex flex-wrap gap-3 align-items-center">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleSoftware" checked>
                <label class="form-check-label fw-bold" for="toggleSoftware">Software</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleModules">
                <label class="form-check-label fw-bold" for="toggleModules">Módulos</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleTerminals">
                <label class="form-check-label fw-bold" for="toggleTerminals">Terminais</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleAccessories">
                <label class="form-check-label fw-bold" for="toggleAccessories">Acessórios / Serviços</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleTechAdvisory">
                <label class="form-check-label fw-bold" for="toggleTechAdvisory">Assessoria Técnica</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleSupport">
                <label class="form-check-label fw-bold" for="toggleSupport">Suporte Técnico</label>
              </div>
            </div>
          </div>

          <!-- SOFTWARE -->
          <div id="secSoftware" class="mt-3">
            <div class="section-head">
              <div class="left"><span class="badge-num">1</span>Software</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addSoftwareRow">
                  <i class="bi bi-plus-lg"></i> Adicionar item
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:42%">Item</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:18%">Tipo</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="softwareBody"></tbody>
              </table>
            </div> 
          </div>

          <!-- MODULES -->
          <div id="secModules" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">2</span>Módulos</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addModuleRow">
                  <i class="bi bi-plus-lg"></i> Adicionar módulo
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:42%">Módulo</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:18%">Modelo</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="modulesBody"></tbody>
              </table>
            </div>
            <div class="pdf-note mt-2">
              “Modelo” define se o valor é instalação (one-off) ou impacto anual.
            </div>
          </div>

          <!-- TERMINALS -->
          <div id="secTerminals" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">3</span>Terminais</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addTerminalRow">
                  <i class="bi bi-plus-lg"></i> Adicionar terminal
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:42%">Terminal</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:18%">Categoria</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="terminalsBody"></tbody>
              </table>
            </div>
          </div>

          <!-- ACCESSORIES -->
          <div id="secAccessories" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">4</span>Acessórios / Serviços</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addAccessoryRow">
                  <i class="bi bi-plus-lg"></i> Adicionar item
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:42%">Item</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:18%">Tipo</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="accessoriesBody"></tbody>
              </table>
            </div>
          </div>

          <!-- TECH ADVISORY -->
          <div id="secTechAdvisory" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">5</span>Assessoria Técnica</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addTechRow">
                  <i class="bi bi-plus-lg"></i> Adicionar pacote
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:38%">Pacote</th>
                    <th style="width:14%">Horas</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:8%"></th>
                  </tr>
                </thead>
                <tbody id="techBody"></tbody>
              </table>
            </div>
            <div class="pdf-note mt-2">
              A implementação pode ser ajustada conforme o número de colaboradores e complexidade do projecto.
            </div>
          </div>

          <!-- SUPPORT -->
          <div id="secSupport" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">6</span>Suporte Técnico</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addSupportRow">
                  <i class="bi bi-plus-lg"></i> Adicionar pack
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:46%">Pack</th>
                    <th style="width:16%">Inclui</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:8%"></th>
                  </tr>
                </thead>
                <tbody id="supportBody"></tbody>
              </table>
            </div>
            <div class="pdf-note mt-2">
              Os packs garantem suporte adequado e resposta rápida, assegurando continuidade operacional e satisfação do cliente.
            </div>
          </div>

          <hr class="my-4">

          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Observações</label>
              <textarea id="notes" class="form-control" rows="3" placeholder="Notas adicionais (opcional)"></textarea>
            </div>
          </div>
          <br>

          <div class="totals-card mb-3">
            <div class="totals-row">
              <div class="k"><i class="bi bi-receipt"></i> Total da proposta</div>
              <div class="v" id="grandTotal">0,00 €</div>
            </div>
            <div class="totals-row">
              <div class="k"><i class="bi bi-arrow-repeat"></i> Subscrição anual</div>
              <div class="v" id="annualTotal">0,00 €</div>
            </div>
            <div class="totals-row">
              <div class="k"><i class="bi bi-box-seam"></i> One-off (instalação/equip.)</div>
              <div class="v" id="oneoffTotal">0,00 €</div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Summary -->
        <div class="panel d-none ">
          <h5>Resumo</h5>
 

          <div class="soft mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-bold" style="color:#0b2e7a">Templates rápidos</div>
              <button class="btn btn-sm btn-ghost" id="resetAll" type="button"><i class="bi bi-arrow-counterclockwise"></i> Limpar</button>
            </div>
            <div class="d-grid gap-2 mt-3">
              <button class="btn btn-outline-primary" type="button" id="loadTemplateHR">
                <i class="bi bi-people"></i> Proposta 2smart HR (exemplo)
              </button>
              <button class="btn btn-outline-primary" type="button" id="loadTemplateSignage">
                <i class="bi bi-display"></i> Proposta Sinalética (exemplo)
              </button>
            </div>
            <div class="pdf-note mt-3">
              Os valores são “base” e podem ser alterados nos campos do formulário.
            </div>
          </div>

          <div class="soft">
            <div class="fw-bold mb-2" style="color:#0b2e7a">Capa e Footer do PDF</div>
            <div class="row g-2">
              <div class="col-12">
                <label class="form-label">URL da capa</label>
                <input id="coverUrl" class="form-control" value="https://ik.imagekit.io/fsobpyaa5i/capa_smart.png?updatedAt=1769508815425">
              </div>
              <div class="col-12">
                <label class="form-label">URL do footer</label>
                <input id="footerUrl" class="form-control" value="https://ik.imagekit.io/fsobpyaa5i/footer_smart.png?updatedAt=1769508815337">
              </div>
              <div class="col-12">
                <label class="form-label">Logótipo 2smart</label>
                <input id="logoUrl" class="form-control" value="https://ik.imagekit.io/fsobpyaa5i/Ativo%208%20(2).png">
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="sticky-actions">
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <div class="loader" id="loader">
            <span class="spinner"></span>
            <span>A gerar PDF…</span>
          </div> 
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-ghost" type="button" id="previewBtn">
            <i class="bi bi-eye"></i> Pré-visualizar PDF
          </button>
          <button class="btn btn-primary" type="button" id="exportBtn">
            <i class="bi bi-filetype-pdf"></i> Exportar PDF
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Hidden PDF render root -->
  <div id="pdfRenderHost"><div id="pdfRoot"></div></div>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-preview-narrow">
      <div class="modal-content" style="border-radius:18px;">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Pré-visualização (HTML do PDF)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="previewArea" class="border rounded-4 p-3" style="background:#fff;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>

    // ---------- Helpers ----------
    const eur = (n) => {
      const v = Number(n || 0);
      return v.toLocaleString("pt-PT", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
    };
    const num = (v) => {
      if (v === null || v === undefined) return 0;
      const s = String(v).replace(",", ".").replace(/[^\d.\-]/g, "");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16); 

    function show(el, on){ el.style.display = on ? "" : "none"; }
 

    // ---------- Catalogs (podes alterar preços depois) ----------
    const CATALOG = {
      software: [
        { label: "2smart HR Cloud — Licença (1º Ano)", price: 6.60, type: "mensal_colab", hint: "€ / colaborador (mês)" },
        { label: "2smart HR Cloud — Subscrição Anual", price: 4.50, type: "anual_colab", hint: "€ / colaborador / ano" },
       /*
        { label: "2smart ISP — Preço de Ativação", price: 60.00, type: "oneoff_terminal", hint: "€ / terminal" },
        { label: "2smart ISP — Subscrição Anual", price: 15.00, type: "anual_terminal", hint: "€ / terminal / ano" }, 
        { label: "CMS Sinalética (Licença + Gestão) — 1º Ano", price: 240.00, type: "oneoff", hint: "€ (1º ano)" },     
        */],
      modules: [
        { label: "Geolocalização & Geofencing", price: 1.00, model: "mensal_colab", hint: "€ / mês por colaborador", desc: "Veja a movimentação, presença e cobertura das equipas." },
        { label: "Integração com ERP", price: 0.65, model: "mensal_colab", hint: "€ / mês por colaborador", desc: "Este módulo melhora a produtividade e reforça o controlo sobre os processos internos da sua empresa." },
        { label: "Automatização de Processos e Envio de Relatórios", price: 8.00, model: "mensal", hint: "€ / mês", desc: "Permite agendar e enviar automaticamente qualquer relatório do 2Smart HR para destinatários pré-definidos." },
      ],
      terminals: [
        { label: "2S-M6PRO - Terminal 2Smart HR Rec. Facial + imp. Digital + RFID 125KHz LCD 4.3″ Luz Visível Wifi", price: 318.00, cat: "Acessos + Assiduidade" },
        { label: "2S-M5PRO -  Terminal 2Smart HR Rec. Facial + imp. Digital + RFID 125KHz LCD 2.8″ Luz Visível Wifi", price: 261.00, cat: "Acessos + Assiduidade" },
        { label: "2S-M2PRO - Terminal 2Smart HR Rec. Facial + imp. Digital + RFID 125KHz LCD 2.8″ Luz Visível Wifi", price: 195.00, cat: "Acessos + Assiduidade" },


        { label: "TA500 — Terminal Controlo Assiduidade (Impressão Digital)", price: 269.00, cat: "Assiduidade" },
        { label: "R3 — Terminal Acessos e Assiduidades (Impressão Digital)", price: 428.00, cat: "Acessos + Assiduidade" },
        { label: "HX-2200 — Terminal Acessos e Assiduidades TCP/IP (RFID WiFi)", price: 265.00, cat: "Acessos + Assiduidade" },
        { label: "VL-SPEEDFACE-V3L-FP-1-W — Terminal Gestão Acessos (Impressão Digital)", price: 195.00, cat: "Acessos" },
        { label: "V5L-TD — Terminal Helix (Facial + Palma + Temperatura)", price: 891.00, cat: "Biométrico Avançado" },
        { label: "SPEEDFACE-C5L — Terminal ZKTeco (RFID + Facial 125KHz)", price: 340.00, cat: "Biométrico" },
        { label: "TA500R — Terminal Controlo Assiduidade (Impressão Digital)", price: 335.00, cat: "Assiduidade" },
        { label: "FACE ID 4 — Terminal Controlo de Assiduidade", price: 443.25, cat: "Assiduidade" },
        { label: "EFACE10 — Terminal Gestão de Assiduidades (Facial)", price: 268.00, cat: "Assiduidade" },
        { label: "VL-SPEEDFACE-V5L-P-I-W — Terminal Gestão Acessos (Facial)", price: 380.00, cat: "Acessos" },
        { label: "C5L-TD — Terminal Reconhecimento Facial (RFID + Temperatura)", price: 790.00, cat: "Biométrico" },
        { label: "S922 — Terminal Acessos e Assiduidades (WiFi | 3G | Impressão Digital)", price: 846.24, cat: "Acessos + Assiduidade" },

        // Sinalética/Shop Window (exemplo do teu PDF)
        { label: "Shop Window LCD 43\" (Série U)", price: 1290.00, cat: "Sinalética" },
        { label: "Shop Window LCD 55\" (Série U)", price: 1590.00, cat: "Sinalética" }
      ],
      accessories: [
        { label: "Instalação (serviço)", price: 220.00, type:"oneoff", hint:"€" },
        { label: "Configuração/Parametrização", price: 180.00, type:"oneoff", hint:"€" },
        { label: "Deslocação (até 30 km)", price: 85.00, type:"oneoff", hint:"€" },
      ],
      tech: [
        { label: "Implementação e formação remota — até 50 colaboradores", hours: 4, price: 145.00 },
        { label: "Implementação e formação  remota — até 120 colaboradores", hours: 5, price: 160.00 },
        { label: "Implementação e formação remota — até 200 colaboradores", hours: 8, price: 280.00 },
        { label: "Implementação e formação  remota — até 300 colaboradores", hours: 16, price: 560.00 },
        { label: "Implementação e formação  remota — mais de 300 colaboradores", hours: 0, price: 0.00 },
        { label: "Formação remota — 4 horas", hours: 4, price: 120.00 },
        { label: "Formação remota — 8 horas", hours: 8, price: 240.00 },
        { label: "Formação — 2smart App", hours: 0, price: 100.00 },
      ],
      support: [
        { label: "2SMART_SERVICE_5", includes: "5h / ano", price: 200.00 },
        { label: "2SMART_SERVICE_10", includes: "10h / ano", price: 400.00 },
        { label: "2SMART_SERVICE_20", includes: "20h / ano", price: 800.00 },
        { label: "Onsite (até 30 km)", includes: "Deslocação", price: 85.00 },
      ]
    };

    // ---------- State ----------
    const state = {
      software: [],
      modules: [],
      terminals: [],
      accessories: [],
      tech: [],
      support: [],
    };

    // ---------- DOM ----------
    const $ = (id) => document.getElementById(id);
    setTimeout(() => {
      let p = document?.querySelector("#refCode") 
      p.value = "PRS2-" +  (Math.random(4,8)*Math.random(8,2)*3).toString().split(".")[1]; 
      console.log(p.value)
    }, 2000);

    

    // --- PDF helpers (evita PDF em branco por CORS/tainted canvas) ---
    const PDF = window.__PDF_PRO__ || (window.__PDF_PRO__ = {});
    PDF.ensureHost = PDF.ensureHost || function(){
      let host = document.getElementById("pdfRenderHost");
      if(!host){
        host = document.createElement("div");
        host.id = "pdfRenderHost";
        document.body.appendChild(host);
      }
      return host;
    };

    PDF.waitImages = PDF.waitImages || function(root){
      const imgs = Array.from(root.querySelectorAll("img"));
      return Promise.all(imgs.map(img => new Promise(resolve => {
        if(img.complete && img.naturalWidth > 0) return resolve();
        const done = () => resolve();
        img.addEventListener("load", done, { once:true });
        img.addEventListener("error", done, { once:true });
      })));
    };

    PDF.toDataURL = PDF.toDataURL || async function(url){
      const res = await fetch(url, { mode: "cors", cache: "no-cache" });
      const blob = await res.blob();
      return await new Promise((resolve) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.readAsDataURL(blob);
      });
    };

    PDF.inlineImages = PDF.inlineImages || async function(root){
      const imgs = Array.from(root.querySelectorAll("img"));
      for(const img of imgs){
        const src = img.getAttribute("src") || "";
        if(!src || src.startsWith("data:")) continue;
        try{
          const data = await PDF.toDataURL(src);
          img.setAttribute("src", data);
        }catch(e){}
      }
    };

// toggles
    const toggles = [
      ["toggleSoftware", "secSoftware"],
      ["toggleModules", "secModules"],
      ["toggleTerminals", "secTerminals"],
      ["toggleAccessories", "secAccessories"],
      ["toggleTechAdvisory", "secTechAdvisory"],
      ["toggleSupport", "secSupport"],
    ];
    toggles.forEach(([t, s]) => {
      $(t).addEventListener("change", () => show($(s), $(t).checked));
    });

    // ---------- Row builders ----------
    function buildSelect(options, selectedLabel){
      const sel = document.createElement("select");
      sel.className = "form-select form-select-sm";
      options.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.label;
        opt.textContent = o.label;
        if (selectedLabel && selectedLabel === o.label) opt.selected = true;
        sel.appendChild(opt);
      });
      return sel;
    }

    function buildInput(value, placeholder, min=0, step="1"){
      const inp = document.createElement("input");
      inp.className = "form-control form-control-sm";
      inp.value = value ?? "";
      inp.placeholder = placeholder || "";
      inp.inputMode = "decimal";
      inp.min = min;
      inp.step = step;
      return inp;
    }

    function buildQty(value=1){
      const inp = buildInput(value, "1", 0, "1");
      inp.type = "number";
      return inp;
    }

    function buildMoney(value){
      const inp = buildInput(value, "0,00", 0, "0.01");
      inp.type = "number";
      inp.step = "0.01";
      return inp;
    }

    function buildPill(text){
      const span = document.createElement("span");
      span.className = "badge text-bg-light border";
      span.style.fontWeight = "800";
      span.style.color = "#0b2e7a";
      span.textContent = text;
      return span;
    }

    function addRow(section, row){
      state[section].push(row);
      render();
    }
    function removeRow(section, id){
      state[section] = state[section].filter(r => r.id !== id);
      render();
    }

    // ---------- Render ----------
    function render(){
      renderSoftware();
      renderModules();
      renderTerminals();
      renderAccessories();
      renderTech();
      renderSupport();
      recalcTotals();
      autoShowSections();
    }

    function autoShowSections(){
      // If user added items but toggle off, keep hidden; user controls.
      // However if toggle on and section empty, still show (so they can add items).
      // We'll do nothing special here besides respecting toggles.
    }

    function renderSoftware(){
      const tbody = $("softwareBody");
      tbody.innerHTML = "";
      state.software.forEach(r => {
        const tr = document.createElement("tr");

        // item select
        const tdItem = document.createElement("td");
        const sel = buildSelect(CATALOG.software, r.label);
        tdItem.appendChild(sel);

        const hint = document.createElement("div");
        hint.className = "muted";
        hint.textContent = (CATALOG.software.find(x => x.label === r.label)?.hint) || "";
        tdItem.appendChild(hint);

        // qty
        const tdQty = document.createElement("td");
        const qty = buildQty(r.qty);
        tdQty.appendChild(qty);

        // unit
        const tdUnit = document.createElement("td");
        const unit = buildMoney(r.unit);
        tdUnit.appendChild(unit);

        // type
        const tdType = document.createElement("td");
        const typeSel = document.createElement("select");
        typeSel.className = "form-select form-select-sm";
        [
          {v:"oneoff", t:"One-off"},
          {v:"anual", t:"Anual"},
          {v:"mensal", t:"Mensal"},
        ].forEach(o=>{
          const opt=document.createElement("option");
          opt.value=o.v; opt.textContent=o.t;
          if (r.kind===o.v) opt.selected=true;
          typeSel.appendChild(opt);
        });
        tdType.appendChild(typeSel);

        // delete
        const tdDel = document.createElement("td");
        tdDel.className = "text-end";
        const del = document.createElement("button");
        del.className = "btn btn-sm btn-outline-danger";
        del.type = "button";
        del.innerHTML = '<i class="bi bi-trash"></i>';
        tdDel.appendChild(del);

        // events
        sel.addEventListener("change", () => {
          r.label = sel.value;
          const found = CATALOG.software.find(x => x.label === r.label);
          r.unit = found ? found.price : r.unit;
          // infer default kind
          if (found?.type?.startsWith("anual")) r.kind = "anual";
          else if (found?.type?.startsWith("mensal")) r.kind = "mensal";
          else r.kind = "oneoff";
          render();
        });
        qty.addEventListener("input", ()=>{ r.qty = num(qty.value); recalcTotals(); });
        unit.addEventListener("input", ()=>{ r.unit = num(unit.value); recalcTotals(); });
        typeSel.addEventListener("change", ()=>{ r.kind = typeSel.value; recalcTotals(); });
        del.addEventListener("click", ()=> removeRow("software", r.id));

        tr.append(tdItem, tdQty, tdUnit, tdType, tdDel);
        tbody.appendChild(tr);
      });
    }

    function renderModules(){
      const tbody = $("modulesBody");
      tbody.innerHTML = "";
      state.modules.forEach(r => {
        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        const sel = buildSelect(CATALOG.modules, r.label);
        tdItem.appendChild(sel);
        const hint = document.createElement("div");
        hint.className = "muted";
        hint.textContent = (CATALOG.modules.find(x => x.label === r.label)?.hint) || "";
        tdItem.appendChild(hint);

        const tdQty = document.createElement("td");
        const qty = buildQty(r.qty);
        tdQty.appendChild(qty);

        const tdUnit = document.createElement("td");
        const unit = buildMoney(r.unit);
        tdUnit.appendChild(unit);

        const tdModel = document.createElement("td");
        const modelSel = document.createElement("select");
        modelSel.className="form-select form-select-sm";
        [
          {v:"oneoff", t:"Disponibilização"},
          {v:"anual", t:"Impacto anual"}
        ].forEach(o=>{
          const opt=document.createElement("option");
          opt.value=o.v; opt.textContent=o.t;
          if (r.model===o.v) opt.selected=true;
          modelSel.appendChild(opt);
        });
        tdModel.appendChild(modelSel);

        const tdDel = document.createElement("td");
        tdDel.className="text-end";
        const del = document.createElement("button");
        del.className="btn btn-sm btn-outline-danger";
        del.type="button";
        del.innerHTML='<i class="bi bi-trash"></i>';
        tdDel.appendChild(del);

        sel.addEventListener("change", () => {
          r.label = sel.value;
          const found = CATALOG.modules.find(x => x.label === r.label);
          r.unit = found ? found.price : r.unit;
          r.model = found?.model === "anual_colab" ? "anual" : (found?.model || r.model);
          render();
        });
        qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
        unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
        modelSel.addEventListener("change", ()=>{ r.model=modelSel.value; recalcTotals(); });
        del.addEventListener("click", ()=> removeRow("modules", r.id));

        tr.append(tdItem, tdQty, tdUnit, tdModel, tdDel);
        tbody.appendChild(tr);
      });
    }

    function renderTerminals(){
      const tbody = $("terminalsBody");
      tbody.innerHTML = "";
      state.terminals.forEach(r => {
        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        const sel = buildSelect(CATALOG.terminals, r.label);
        tdItem.appendChild(sel);

        const tdQty = document.createElement("td");
        const qty = buildQty(r.qty);
        tdQty.appendChild(qty);

        const tdUnit = document.createElement("td");
        const unit = buildMoney(r.unit);
        tdUnit.appendChild(unit);

        const tdCat = document.createElement("td");
        tdCat.appendChild(buildPill(r.cat || "—"));

        const tdDel = document.createElement("td");
        tdDel.className="text-end";
        const del = document.createElement("button");
        del.className="btn btn-sm btn-outline-danger";
        del.type="button";
        del.innerHTML='<i class="bi bi-trash"></i>';
        tdDel.appendChild(del);

        sel.addEventListener("change", () => {
          r.label = sel.value;
          const found = CATALOG.terminals.find(x => x.label === r.label);
          r.unit = found ? found.price : r.unit;
          r.cat = found ? found.cat : r.cat;
          render();
        });
        qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
        unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
        del.addEventListener("click", ()=> removeRow("terminals", r.id));

        tr.append(tdItem, tdQty, tdUnit, tdCat, tdDel);
        tbody.appendChild(tr);
      });
    }

    function renderAccessories(){
      const tbody = $("accessoriesBody");
      tbody.innerHTML = "";
      state.accessories.forEach(r => {
        const tr = document.createElement("tr");

        // Item: campo livre com sugestões (datalist)
        const tdItem = document.createElement("td");

        const dlId = "dl_acc_" + r.id;
        const datalist = document.createElement("datalist");
        datalist.id = dlId;
        CATALOG.accessories.forEach(o=>{
          const opt = document.createElement("option");
          opt.value = o.label;
          datalist.appendChild(opt);
        });

        const itemInp = document.createElement("input");
        itemInp.className = "form-control form-control-sm";
        itemInp.placeholder = "Ex: Instalação, Configuração, Cabo, etc.";
        itemInp.value = r.label ?? "";
        itemInp.setAttribute("list", dlId);

        tdItem.appendChild(itemInp);
        tdItem.appendChild(datalist);

        const hint = document.createElement("div");
        hint.className="muted";
        const found0 = CATALOG.accessories.find(x=>x.label===r.label);
        hint.textContent = found0?.hint || "";
        tdItem.appendChild(hint);

        const tdQty = document.createElement("td");
        const qty = buildQty(r.qty);
        tdQty.appendChild(qty);

        const tdUnit = document.createElement("td");
        const unit = buildMoney(r.unit);
        tdUnit.appendChild(unit);

        const tdType = document.createElement("td");
        const typeSel = document.createElement("select");
        typeSel.className="form-select form-select-sm";
        [
          {v:"oneoff", t:"One-off"},
          {v:"anual", t:"Anual"},
        ].forEach(o=>{
          const opt=document.createElement("option");
          opt.value=o.v; opt.textContent=o.t;
          if (r.kind===o.v) opt.selected=true;
          typeSel.appendChild(opt);
        });
        tdType.appendChild(typeSel);

        const tdDel = document.createElement("td");
        tdDel.className="text-end";
        const del = document.createElement("button");
        del.className="btn btn-sm btn-outline-danger";
        del.type="button";
        del.innerHTML='<i class="bi bi-trash"></i>';
        tdDel.appendChild(del);

        // events
        itemInp.addEventListener("input", ()=>{
          r.label = itemInp.value;
          const found = CATALOG.accessories.find(x=>x.label===r.label);
          hint.textContent = found?.hint || "";
          if(found){
            // Se o item existir no catálogo, sugerir preço e tipo
            r.unit = found.price;
            r.kind = (found.type === "anual") ? "anual" : "oneoff";
            unit.value = r.unit;
            typeSel.value = r.kind;
          }
          recalcTotals();
        });

        qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
        unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
        typeSel.addEventListener("change", ()=>{ r.kind=typeSel.value; recalcTotals(); });
        del.addEventListener("click", ()=> removeRow("accessories", r.id));

        tr.append(tdItem, tdQty, tdUnit, tdType, tdDel);
        tbody.appendChild(tr);
      });
    }

    function renderTech(){
      const tbody = $("techBody");
      tbody.innerHTML = "";
      state.tech.forEach(r=>{
        const tr=document.createElement("tr");

        const tdPack=document.createElement("td");
        const sel=buildSelect(CATALOG.tech, r.label);
        tdPack.appendChild(sel);

        const tdHours=document.createElement("td");
        const hours=buildInput(r.hours ?? "", "Horas", 0, "1");
        hours.type="number";
        tdHours.appendChild(hours);

        const tdQty=document.createElement("td");
        const qty=buildQty(r.qty);
        tdQty.appendChild(qty);

        const tdUnit=document.createElement("td");
        const unit=buildMoney(r.unit);
        tdUnit.appendChild(unit);

        const tdDel=document.createElement("td");
        tdDel.className="text-end";
        const del=document.createElement("button");
        del.className="btn btn-sm btn-outline-danger";
        del.type="button";
        del.innerHTML='<i class="bi bi-trash"></i>';
        tdDel.appendChild(del);

        sel.addEventListener("change", ()=>{
          r.label=sel.value;
          const found=CATALOG.tech.find(x=>x.label===r.label);
          r.hours = found ? found.hours : r.hours;
          r.unit = found ? found.price : r.unit;
          render();
        });
        hours.addEventListener("input", ()=>{ r.hours=num(hours.value); });
        qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
        unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
        del.addEventListener("click", ()=> removeRow("tech", r.id));

        tr.append(tdPack, tdHours, tdQty, tdUnit, tdDel);
        tbody.appendChild(tr);
      });
    }

    function renderSupport(){
      const tbody=$("supportBody");
      tbody.innerHTML="";
      state.support.forEach(r=>{
        const tr=document.createElement("tr");

        const tdPack=document.createElement("td");
        const sel=buildSelect(CATALOG.support, r.label);
        tdPack.appendChild(sel);

        const tdInc=document.createElement("td");
        tdInc.appendChild(buildPill(r.includes || "—"));

        const tdQty=document.createElement("td");
        const qty=buildQty(r.qty);
        tdQty.appendChild(qty);

        const tdUnit=document.createElement("td");
        const unit=buildMoney(r.unit);
        tdUnit.appendChild(unit);

        const tdDel=document.createElement("td");
        tdDel.className="text-end";
        const del=document.createElement("button");
        del.className="btn btn-sm btn-outline-danger";
        del.type="button";
        del.innerHTML='<i class="bi bi-trash"></i>';
        tdDel.appendChild(del);

        sel.addEventListener("change", ()=>{
          r.label=sel.value;
          const found=CATALOG.support.find(x=>x.label===r.label);
          r.includes = found ? found.includes : r.includes;
          r.unit = found ? found.price : r.unit;
          render();
        });
        qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
        unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
        del.addEventListener("click", ()=> removeRow("support", r.id));

        tr.append(tdPack, tdInc, tdQty, tdUnit, tdDel);
        tbody.appendChild(tr);
      });
    }

    // ---------- Totals ----------
    function recalcTotals(){
      // Annual = items marked annual + module model annual
      let annual = 0;
      let monthly = 0;
      let oneoff = 0;

      const softwareTotals = state.software.map(r=>{
        const line = num(r.qty) * num(r.unit);
        if (r.kind === "anual") annual += line;
        else if (r.kind === "mensal") {
          monthly += line;
        } else oneoff += line;
        return line;
      });

      const moduleTotals = state.modules.map(r=>{
        const line = num(r.qty) * num(r.unit);
        if (r.model === "anual") annual += line;
        else if (r.model === "mensal" || r.model === "mensal_colab") monthly += line;
        else oneoff += line;
        return line;
      });

      const terminalTotals = state.terminals.map(r=>{
        const line = num(r.qty) * num(r.unit);
        oneoff += line;
        return line;
      });

      const accessoryTotals = state.accessories.map(r=>{
        const line = num(r.qty) * num(r.unit);
        if (r.kind === "anual") annual += line;
        else oneoff += line;
        return line;
      });

      const techTotals = state.tech.map(r=>{
        const line = num(r.qty) * num(r.unit);
        oneoff += line;
        return line;
      });

      const supportTotals = state.support.map(r=>{
        const line = num(r.qty) * num(r.unit);
        oneoff += line;
        return line;
      });

      const grand = annual + oneoff;

      $("annualTotal").textContent = eur(annual);
      $("oneoffTotal").textContent = eur(oneoff);
      if (document.getElementById("monthlyTotal")) $("monthlyTotal").textContent = eur(monthly);
      $("grandTotal").textContent = eur(grand);
    }

    // ---------- Defaults / Templates ----------
    function addDefaultRow(section, catalog, label){
      const found = catalog.find(x=>x.label===label) || catalog[0];
      if (!found) return;

      if (section === "software"){
        addRow("software", { id: uid(), label: found.label, qty: 1, unit: found.price, kind: (found.type?.startsWith("anual") ? "anual" : (found.type?.startsWith("mensal") ? "mensal" : "oneoff")) });
      } else if (section === "modules"){
        addRow("modules", { id: uid(), label: found.label, qty: 1, unit: found.price, model: (found.model === "anual_colab" ? "anual" : "oneoff") });
      } else if (section === "terminals"){
        addRow("terminals", { id: uid(), label: found.label, qty: 1, unit: found.price, cat: found.cat });
      } else if (section === "accessories"){
        addRow("accessories", { id: uid(), label: found.label, qty: 1, unit: found.price, kind: (found.type==="anual" ? "anual" : "oneoff") });
      } else if (section === "tech"){
        addRow("tech", { id: uid(), label: found.label, hours: found.hours, qty: 1, unit: found.price });
      } else if (section === "support"){
        addRow("support", { id: uid(), label: found.label, includes: found.includes, qty: 1, unit: found.price });
      }
    }

    function resetAll(){
      state.software = [];
      state.modules = [];
      state.terminals = [];
      state.accessories = [];
      state.tech = [];
      state.support = [];
      $("notes").value = "";
      render();
    }

    $("resetAll").addEventListener("click", resetAll);

    $("addSoftwareRow").addEventListener("click", ()=> addDefaultRow("software", CATALOG.software));
    $("addModuleRow").addEventListener("click", ()=> addDefaultRow("modules", CATALOG.modules));
    $("addTerminalRow").addEventListener("click", ()=> addDefaultRow("terminals", CATALOG.terminals));
    $("addAccessoryRow").addEventListener("click", ()=> addDefaultRow("accessories", CATALOG.accessories));
    $("addTechRow").addEventListener("click", ()=> addDefaultRow("tech", CATALOG.tech));
    $("addSupportRow").addEventListener("click", ()=> addDefaultRow("support", CATALOG.support));

    $("loadTemplateHR").addEventListener("click", ()=>{
      resetAll();
      $("toggleSoftware").checked = true; show($("secSoftware"), true);
      $("toggleModules").checked = true; show($("secModules"), true);
      $("toggleTerminals").checked = true; show($("secTerminals"), true);
      $("toggleTechAdvisory").checked = true; show($("secTechAdvisory"), true);
      $("toggleSupport").checked = true; show($("secSupport"), true);

      $("projectName").value = "Implementação 2smart HR";
      $("clientName").value = "";
      $("validity").value = "30 dias";

      addDefaultRow("software", CATALOG.software, "2smart HR Cloud — Licença (1º Ano)");
      // Exemplo: 50 colaboradores
      state.software[0].qty = 50;

      addDefaultRow("software", CATALOG.software, "2smart HR Cloud — Subscrição Anual");
      state.software[1].qty = 50;

      addDefaultRow("modules", CATALOG.modules, "Integração com ERP");
      
      state.modules[0].qty = 50;

      addDefaultRow("terminals", CATALOG.terminals, "TA500 — Terminal Controlo Assiduidade (Impressão Digital)");
      state.terminals[0].qty = 1;

      addDefaultRow("tech", CATALOG.tech, "Implementação remota — até 50 colaboradores");
      addDefaultRow("support", CATALOG.support, "2SMART_SERVICE_5");

      $("notes").value = "Proposta sujeita a validação técnica final. Valores indicados sem IVA.";
      render();
    });

    $("loadTemplateSignage").addEventListener("click", ()=>{
      resetAll();
      $("toggleTerminals").checked = true; show($("secTerminals"), true);
      $("toggleAccessories").checked = true; show($("secAccessories"), true);
      $("toggleSoftware").checked = true; show($("secSoftware"), true);

      $("projectName").value = "Projeto Sinalética Digital";
      $("refCode").value = "";

      addDefaultRow("terminals", CATALOG.terminals, "Shop Window LCD 43\" (Série U)");
      state.terminals[0].qty = 2;

      addDefaultRow("accessories", CATALOG.accessories, "Instalação (serviço)");
      state.accessories[0].qty = 1;

      addDefaultRow("software", CATALOG.software, "CMS Sinalética (Licença + Gestão) — 1º Ano");
      state.software[0].qty = 2;
      state.software[0].kind = "oneoff";

      $("notes").value = "Conteúdos e calendário de publicações a definir com o cliente.";
      render();
    });

    // ---------- PDF builder ----------
    function sectionToPDF(title, rows, options={}){
      const { columns } = options;
      if (!rows || rows.length === 0) return "";

      const thead = columns.map(c => `<th>${c}</th>`).join("");
      const tbody = rows.map(r => `<tr>${r.map((cell, idx)=> `<td>${cell}</td>`).join("")}</tr>`).join("");

      return `
        <div class="pdf-section-title">${title}</div>
        <table class="pdf-table">
          <thead><tr>${thead}</tr></thead>
          <tbody>${tbody}</tbody>
        </table>
      `;
    }

    function buildPDFHtml(){
      const coverUrl = $("coverUrl").value.trim();
      const footerUrl = $("footerUrl").value.trim();
      const logoUrl = $("logoUrl").value.trim();

      const projectName = $("projectName").value.trim() || "Proposta Comercial";
      const refCode = $("refCode").value.trim() || "";
      const clientName = $("clientName").value.trim() || "";
      const validity = $("validity").value.trim() || "";
      const salesName = $("salesName").value.trim() || "";
      const salesRole = $("salesRole").value.trim() || "";
      const salesEmail = $("salesEmail").value.trim() || "";
      const notes = $("notes").value.trim() || "";
      const genDate = new Date().toLocaleDateString("pt-PT");

      // Totals
      // (recalc first)
      recalcTotals();
      const annual = $("annualTotal").textContent;
      const oneoff = $("oneoffTotal").textContent;
      const monthly = (document.getElementById("monthlyTotal") ? $("monthlyTotal").textContent : "€0,00");
      const grand = $("grandTotal").textContent;

      // Rows per section
      const softwareRows = state.software.map(r=>{
        const line = num(r.qty) * num(r.unit);
        const kind = r.kind === "anual" ? "Anual" : (r.kind === "mensal" ? "Mensal" : "One-off");
        return [
          `<b>${escapeHtml(r.label)}</b>`,
          `${escapeHtml(String(r.qty || 0))}`,
          `${eur(r.unit)}`,
          `${kind}`,
          `<b>${eur(line)}</b>`
        ];
      });

      const moduleRows = state.modules.map(r=>{
        const line = num(r.qty) * num(r.unit);
        const model = r.model === "anual" ? "Anual" : (r.model === "mensal" ? "Mensal" : (r.model === "mensal_colab" ? "Mensal (por colaborador)" : "One-off"));
        return [
          `<b>${escapeHtml(r.label)}</b>`,
          `${escapeHtml(String(r.qty || 0))}`,
          `${eur(r.unit)}`,
          `${model}`,
          `<b>${eur(line)}</b>`
        ];
      });

      const terminalRows = state.terminals.map(r=>{
        const line = num(r.qty) * num(r.unit);
        return [
          `<b>${escapeHtml(r.label)}</b><div style="font-size:10px;color:#5a6c87;font-weight:700;margin-top:2px">${escapeHtml(r.cat||"")}</div>`,
          `${escapeHtml(String(r.qty || 0))}`,
          `${eur(r.unit)}`,
          `<b>${eur(line)}</b>`
        ];
      });

      const accessoryRows = state.accessories.map(r=>{
        const line = num(r.qty) * num(r.unit);
        const kind = r.kind === "anual" ? "Anual" : "One-off";
        return [
          `<b>${escapeHtml(r.label)}</b>`,
          `${escapeHtml(String(r.qty || 0))}`,
          `${eur(r.unit)}`,
          `${kind}`,
          `<b>${eur(line)}</b>`
        ];
      });

      const techRows = state.tech.map(r=>{
        const line = num(r.qty) * num(r.unit);
        const hours = (num(r.hours) > 0) ? `${num(r.hours)}h` : "Sob consulta";
        return [
          `<b>${escapeHtml(r.label)}</b>`,
          `${hours}`,
          `${escapeHtml(String(r.qty || 0))}`,
          `${eur(r.unit)}`,
          `<b>${eur(line)}</b>`
        ];
      });

      const supportRows = state.support.map(r=>{
        const line = num(r.qty) * num(r.unit);
        return [
          `<b>${escapeHtml(r.label)}</b>`,
          `${escapeHtml(r.includes || "")}`,
          `${escapeHtml(String(r.qty || 0))}`,
          `${eur(r.unit)}`,
          `<b>${eur(line)}</b>`
        ];
      });

      const showSoftware = $("toggleSoftware").checked && softwareRows.length;
      const showModules = $("toggleModules").checked && moduleRows.length;
      const showTerminals = $("toggleTerminals").checked && terminalRows.length;
      const showAccessories = $("toggleAccessories").checked && accessoryRows.length;
      const showTech = $("toggleTechAdvisory").checked && techRows.length;
      const showSupport = $("toggleSupport").checked && supportRows.length;

      // Build pages:
      // Page 1: cover
      // Page 2+: proposal content; keep footer image at bottom.
      const content = `
        <div class="pdf-cover">
          <img src="${escapeAttr(coverUrl)}" alt="Capa">
        </div>

        <div class="pdf-flow">
<div class="pdf-header">
            <div class="meta">
              <h2>Proposta Comercial</h2>
              <p style="margin-top:4px">Documento gerado em <b>${escapeHtml(genDate)}</b></p>
            </div>
            <img class="logo" src="${escapeAttr(logoUrl)}" alt="2smart">
          </div>

          <div class="pdf-meta">
            <div class="pdf-meta-grid">
              <div class="pdf-meta-item"><b>Cliente</b>${clientName ? `<span><b style="all:unset;font-weight:800;color:#0d1b2a">${escapeHtml(clientName)}</b></span>` : "—"}</div>
              <div class="pdf-meta-item"><b>Projeto</b>${projectName ? `<span><b style="all:unset;font-weight:800;color:#0d1b2a">${escapeHtml(projectName)}</b></span>` : "—"}</div>
              <div class="pdf-meta-item"><b>Referência</b>${refCode ? escapeHtml(refCode) : "—"}</div>
              <div class="pdf-meta-item"><b>Validade</b>${validity ? escapeHtml(validity) : "—"}</div>
              <div class="pdf-meta-item"><b>Comercial</b>${salesName ? escapeHtml(salesName) : "—"}${salesRole ? ` <span style="color:#5a6c87;font-weight:700">(${escapeHtml(salesRole)})</span>` : ""}</div>
              <div class="pdf-meta-item"><b>Email</b>${salesEmail ? escapeHtml(salesEmail) : "—"}</div>
            </div>
          </div>

          <div class="pdf-block">
            ${showSoftware ? sectionToPDF("Software", softwareRows, { columns: ["Item","Qtd.","Valor unitário","Tipo","Total"] }) : ""}
            ${showModules ? sectionToPDF("Módulos", moduleRows, { columns: ["Módulo","Qtd.","Valor unitário","Modelo","Total"] }) : ""}
            ${showTerminals ? sectionToPDF("Terminais", terminalRows, { columns: ["Item","Qtd.","Valor unitário","Total"] }) : ""}
            ${showAccessories ? sectionToPDF("Acessórios / Serviços", accessoryRows, { columns: ["Item","Qtd.","Valor unitário","Tipo","Total"] }) : ""}
            ${showTech ? sectionToPDF("Assessoria Técnica", techRows, { columns: ["Pacote","Horas","Qtd.","Valor unitário","Total"] }) : ""}
            ${showSupport ? sectionToPDF("Suporte Técnico", supportRows, { columns: ["Pack","Inclui","Qtd.","Valor unitário","Total"] }) : ""}

        ${notes ? `
  <div class="pdf-section-title">Observações</div>
  <div style="
    border:1px solid #e8eef7;
    border-radius:12px;
    padding:12px;
    font-size:11px;
    line-height:1.6;
    color:#30425e;
    font-weight:500;
    background:#fbfdff;
  ">
    ${escapeHtml(notes).replace(/\n/g, "<br>")}
  </div>
` : ""}


          <div class="pdf-totals">
            <div class="pdf-chip">Total proposta: <span>${escapeHtml(grand)}</span></div>
            <div class="pdf-chip">Subscrição anual: <span>${escapeHtml(annual)}</span></div>
            <div class="pdf-chip">Mensal: <span>${escapeHtml(monthly)}</span></div>
            <div class="pdf-chip">One-off: <span>${escapeHtml(oneoff)}</span></div>
          </div>

          <div style="height:24px"></div>
        </div>

        <div class="pdf-footer">
          <img src="${escapeAttr(footerUrl)}" alt="Rodapé">
        </div>
      `;

      return content;
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str).replaceAll("\n",""); }

    // ---------- Preview & Export ----------
    async function ensureImagesLoaded(root){
      const imgs = Array.from(root.querySelectorAll("img"));
      await Promise.all(imgs.map(img => {
        if (img.complete && img.naturalWidth) return Promise.resolve();
        return new Promise((res) => {
          img.onload = () => res();
          img.onerror = () => res(); // don't block if an image fails
        });
      }));
    }

    async function renderPdfRoot(){
      const root = $("pdfRoot");
      root.innerHTML = buildPDFHtml();
      await ensureImagesLoaded(root);
      return root;
    }

    $("previewBtn").addEventListener("click", async ()=>{
      const root = await renderPdfRoot();
      $("previewArea").innerHTML = root.innerHTML;
      const modal = new bootstrap.Modal(document.getElementById("previewModal"));
      modal.show();
    });

    
    
    
    async function exportPdfWithMode(qMode){
      const loader = $("loader");
      loader.classList.add("show");

      try{
        window.scrollTo(0,0);

        const root = await renderPdfRoot();
        const host = PDF.ensureHost();

        const originalParent = root.parentElement;
        const originalNext = root.nextElementSibling;
        host.appendChild(root);

        root.style.width = "794px";
        root.style.margin = "0";
        root.style.padding = "0";
        root.style.transform = "none";
        root.style.position = "relative";
        root.style.left = "0";
        root.style.top = "0";

        await PDF.inlineImages(root);
        await PDF.waitImages(root);
        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

        const refCode = ($("refCode").value.trim() || "sem-codigo");
        const filename = `2Smart HR - proposta comercial - ${sanitizeFile(refCode)}.pdf`;

        const SCALE = (qMode === "light") ? 1.35 : (qMode === "balanced" ? 2.1 : 3.0);
        const JPEG_Q = (qMode === "light") ? 0.72 : (qMode === "balanced" ? 0.86 : 0.995);
        const FOOT_Q = (qMode === "light") ? 0.72 : (qMode === "balanced" ? 0.86 : 0.98);

        // Remover footer temporariamente para o PDF do conteúdo (evita misturas/páginas vazias)
        const footerEl = root.querySelector(".pdf-footer");
        let footerNext = null;
        let footerParent = null;
        if(footerEl){
          footerParent = footerEl.parentNode;
          footerNext = footerEl.nextSibling;
          footerEl.remove();
        }

        // Agora o root tem: capa + conteúdo (sem footer)
        const opt = {
          margin: [0,0,0,0],
          filename,
          image: { type: "jpeg", quality: JPEG_Q },
          html2canvas: {
            scale: SCALE,
            useCORS: true,
            allowTaint: false,
            backgroundColor: "#ffffff",
            windowWidth: 794,
            windowHeight: 1123,
            scrollX: 0,
            scrollY: 0,
            x: 0,
            y: 0
          },
          jsPDF: { unit: "px", format: [794,1123], orientation: "portrait" },
          // Evita empurrões grandes (mas mantém respeito por page-break CSS)
          pagebreak: { mode: ["css", "legacy"] }
        };

        const worker = html2pdf().set(opt).from(root).toPdf();
        const pdf = await worker.get("pdf");

        // Remover páginas vazias extra no fim (quando o motor cria folhas sem conteúdo)
        const expectedPages = Math.max(1, Math.ceil(root.scrollHeight / 1123));
        while(pdf.getNumberOfPages() > expectedPages){
          pdf.deletePage(pdf.getNumberOfPages());
        }

        // Repor footer no DOM
        if(footerEl && footerParent){
          if(footerNext) footerParent.insertBefore(footerEl, footerNext);
          else footerParent.appendChild(footerEl);
        }

        // Anexar footer como última página
        if(footerEl){
          // garantir imagens do footer prontas
          await PDF.inlineImages(footerEl);
          await PDF.waitImages(footerEl);

          const canvas = await html2canvas(footerEl, opt.html2canvas);
          const imgData = canvas.toDataURL("image/jpeg", FOOT_Q);
          pdf.addPage([794,1123], "portrait");
          pdf.addImage(imgData, "JPEG", 0, 0, 794, 1123);
        }

        pdf.save(filename);

        // restore root
        if(originalParent){
          if(originalNext) originalParent.insertBefore(root, originalNext);
          else originalParent.appendChild(root);
        }
      } catch(err){
        console.error(err);
        alert("Não foi possível gerar o PDF. Confirma as URLs da capa/footer/logo e tenta novamente.");
      } finally{
        loader.classList.remove("show");
      }
    }

    function bindPdfDownloadModal(){
      const btnExport = document.getElementById("exportBtn");
      const btnO = document.getElementById("dlPdfOriginal");
      const btnB = document.getElementById("dlPdfBalanced");
      const btnL = document.getElementById("dlPdfLight");
      const modalEl = document.getElementById("downloadPdfModal");

      if(btnExport && modalEl){
        btnExport.addEventListener("click", ()=>{
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        });
      }

      // Os botões podem não existir se o modal não estiver no DOM (ou se foi removido).
      if(btnO){
        btnO.addEventListener("click", ()=>{
          bootstrap.Modal.getInstance(modalEl)?.hide();
          exportPdfWithMode("original");
        });
      }
      if(btnB){
        btnB.addEventListener("click", ()=>{
          bootstrap.Modal.getInstance(modalEl)?.hide();
          exportPdfWithMode("balanced");
        });
      }
      if(btnL){
        btnL.addEventListener("click", ()=>{
          bootstrap.Modal.getInstance(modalEl)?.hide();
    // (removido) não exportar automaticamente no refresh
        });
      }
    }

    // Garante que o DOM (incluindo o modal) já existe
    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", bindPdfDownloadModal);
    } else {
      bindPdfDownloadModal();
    }
//exportPdfWithMode("light");
 
function sanitizeFile(s){
      return String(s || "Proposta")
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^\w\-]+/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    // ---------- Init defaults (ligeiros) ----------
    // Começa com uma linha software (podes remover)
    addDefaultRow("software", CATALOG.software, "2smart HR Cloud — Licença (1º Ano)");
    state.software[0].qty = 50;

    // Ref vazio por defeito
    $("refCode").value = "";

    // Update logo in header when user edits URL
    $("logoUrl").addEventListener("input", ()=>{
      $("brandLogo").src = $("logoUrl").value.trim();
    });

    render();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Modal: Download PDF -->
  <div class="modal fade" id="downloadPdfModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:520px">
      <div class="modal-content" style="border-radius:18px; overflow:hidden">
        <div class="modal-header" style="border:0; padding:16px 18px 8px">
          <h5 class="modal-title" style="font-weight:800">Exportar PDF</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" style="padding:10px 18px 18px">
          <p style="margin:0 0 12px; color:#5a6c87; font-weight:600">Escolhe o tamanho do ficheiro (qualidade vs. peso):</p>
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" id="dlPdfOriginal">Original (alta qualidade)</button>
            <button type="button" class="btn btn-outline-primary" id="dlPdfBalanced">Equilibrado (recomendado)</button>
            <button type="button" class="btn btn-outline-secondary" id="dlPdfLight">Leve (mais compressão)</button>
          </div>
          <div style="margin-top:10px; font-size:12px; color:#7a8aa3; font-weight:600">
            Dica: “Leve” reduz o tamanho do PDF com pequena perda de nitidez.
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>