<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2smart | Calculadora de orçamentos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="https://2smart.pt/assets/images//2Smart.png" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --b0:#061735;
      --b1:#0b2e7a;
      --b2:#0b5cff;
      --b3:#7aa7ff;
      --card:#0b1c3a;
      --ink:#0d1b2a;
      --muted:#6b7a90;
      --line:#e9eef6;
      --soft:#f6f8fc;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #0b1220;
      background:
        radial-gradient(900px 600px at 15% 20%, rgba(0, 102, 255, 0.45), transparent 60%),
        radial-gradient(800px 500px at 85% 25%, rgba(120, 170, 255, 0.45), transparent 55%),
        radial-gradient(1000px 700px at 50% 90%, rgba(10, 40, 120, 0.55), transparent 65%),
        linear-gradient(180deg, #eaf1ff 0%, #cddcff 40%, #4b78ff 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .shell{ padding: 28px 0 50px; }
    .app-card{
      background: rgba(255,255,255,.90);
      border: 1px solid rgba(255,255,255,.25);
      border-radius: 22px;
      box-shadow: 0 25px 70px rgba(0,0,0,.25);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      padding: 18px 22px;
      background: linear-gradient(90deg, rgba(11,92,255,.10), rgba(122,167,255,.12));
      border-bottom: 1px solid rgba(13,27,42,.08);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ height: 28px; width:auto; }
    .brand .title{ line-height: 1.1; }
    .brand .title b{ display:block; font-size: 14px; }

    .grid{
      display:flex;
      justify-content: center;
      align-items: center;
      height:100%;
      width:100%;
      gap: 16px;
      padding: 18px 22px 22px;
    }
    @media (max-width: 992px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: #fff;
      border: 1px solid rgba(13,27,42,.08);
      border-radius: 18px;
      padding: 16px;
    }

    .panel h5{
      font-weight: 800;
      font-size: 14px;
      margin: 0 0 10px;
      letter-spacing: .2px;
    }

    .section-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 10px 0 8px;
    }
    .section-head .left{
      display:flex; align-items:center; gap:10px;
      font-weight: 800;
      color: #0b2e7a;
      font-size: 13px;
    }
    .section-head .left .badge-num{
      width: 28px; height: 28px; border-radius: 999px;
      display:grid; place-items:center;
      border: 2px solid rgba(11,92,255,.45);
      color: #0b5cff;
      font-weight: 800;
      font-size: 12px;
      background: rgba(11,92,255,.06);
    }

    .mini-actions{ display:flex; gap: 8px; flex-wrap: wrap; }

    .soft{
      background: var(--soft);
      border: 1px solid rgba(13,27,42,.08);
      border-radius: 14px;
      padding: 12px;
    }
    .form-label{
      font-size: 12px;
      font-weight: 700;
      color: #294a86;
    }
    .table-lite{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(13,27,42,.08);
    }
    .table-lite th, .table-lite td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(13,27,42,.06);
      font-size: 12px;
      vertical-align: middle;
    }
    .table-lite thead th{
      background: linear-gradient(90deg, rgba(11,92,255,.12), rgba(122,167,255,.10));
      font-weight: 800;
      color: #0b2e7a;
      border-bottom: 1px solid rgba(13,27,42,.08);
    }
    .table-lite tr:last-child td{ border-bottom: 0; }
    .table-lite td .muted{ color: var(--muted); font-weight: 600; font-size: 11px; }

    .btn-ghost{
      border: 1px solid rgba(13,27,42,.12);
      background: #fff;
    }
    .btn-ghost:hover{ background: rgba(11,92,255,.05); border-color: rgba(11,92,255,.22); }

    .totals-card{
      background: linear-gradient(160deg, rgba(11,92,255,.12), rgba(122,167,255,.08));
      border: 1px solid rgba(11,92,255,.18);
      border-radius: 18px;
      padding: 14px;
    }
    .totals-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(13,27,42,.08);
      margin-bottom: 10px;
    }
    .totals-row:last-child{ margin-bottom:0; }
    .totals-row .k{
      font-weight: 800;
      color:#0b2e7a;
      font-size: 12px;
    }
    .totals-row .v{
      font-weight: 900;
      font-size: 14px;
    }

    .sticky-actions{
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.92);
      border-top: 1px solid rgba(13,27,42,.08);
      padding: 14px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 768px){
      .sticky-actions{ flex-direction: column; align-items: stretch; }
    }

    .loader{
      display:none;
      align-items:center;
      gap:10px;
      font-weight:700;
      color:#0b2e7a;
      font-size: 12px;
    }
    .loader.show{ display:flex; }
    .spinner{
      width: 18px; height:18px;
      border-radius: 999px;
      border: 3px solid rgba(11,92,255,.25);
      border-top-color: rgba(11,92,255,.95);
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    #pdfRoot{
      width: 794px;
      background:#fff;
      color:#0d1b2a;
      font-family:"Montserrat", Arial, sans-serif;
    }

    .pdf-meta{
      margin: 0 36px 14px;
      padding: 14px 14px;
      border: 1px solid #e6eefb;
      border-radius: 14px;
      background: #f7fbff;
    }
    .pdf-meta-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 18px;
      font-size: 11px;
      color:#30425e;
      font-weight: 600;
      line-height: 1.45;
    }
    .pdf-meta-item b{
      display:block;
      font-size: 10px;
      letter-spacing: .2px;
      color:#0b2e7a;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .pdf-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      padding: 24px 36px 10px;
    }
    .pdf-header .meta h2{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      color:#0b2e7a;
    }
    .pdf-header .meta p{
      margin:6px 0 0;
      font-size: 12px;
      color:#51627c;
      font-weight: 600;
    }
    .pdf-header .logo{ height: 34px; }
    .pdf-block{ padding: 0 36px 14px; }

    .pdf-section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 14px 0 8px;
      font-weight: 900;
      color:#0b2e7a;
      font-size: 13px;
    }
    .pdf-table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid #e8eef7;
      border-radius: 12px;
      overflow:hidden;
    }
    .pdf-table th, .pdf-table td{
      font-size: 11px;
      padding: 10px 10px;
      border-bottom: 1px solid #eef3fb;
      vertical-align: top;
    }
    .pdf-table thead th{
      background: #eef5ff;
      color:#0b2e7a;
      font-weight: 900;
      border-bottom: 1px solid #e0e9f8;
    }
    .pdf-table tr:last-child td{ border-bottom:0; }
    .pdf-table td:last-child, .pdf-table th:last-child{ text-align:right; }

    .pdf-totals{
      display:flex;
      gap:10px;
      padding: 12px 36px 0;
      flex-wrap: wrap;
    }
    .pdf-chip{
      border: 1px solid #e0e9f8;
      background: #f7faff;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 900;
      color:#0b2e7a;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pdf-chip span{ color:#0d1b2a; font-weight: 900; }

    @page { margin: 0; }
    html, body { margin:0; padding:0; }

    #pdfRenderHost{
      position: fixed;
      left: -10000px;
      top: 0;
      width: 794px;
      height: auto;
      opacity: 1;
      z-index: -1;
      pointer-events: none;
      overflow: visible;
    }

    .pdf-,
    .pdf-footer{
      width: 794px;
      height: 1123px;
      font-size: 0;
      line-height: 0;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden;
      background:#fff;
      position: relative;
    }
    .pdf-{ height: 1122px; page-break-after: always; }
    .pdf-footer{ page-break-before: always; page-break-after: auto; }
    .pdf- img,
    .pdf-footer img{
      width: 100%;
      height: 100%;
      display:block;
    }

    .pdf-flow{
      width: 794px;
      margin: 0 !important;
      padding: 0 !important;
      background:#fff;
    }

    .modal-dialog.modal-preview-narrow{ max-width: 920px; }
  </style>
</head>

<body>
  <div class="container shell">
    <div class="app-card">

      <div class="topbar">
        <div class="brand">
          <img id="brandLogo" alt="2smart" src="https://ik.imagekit.io/fsobpyaa5i/Ativo%208%20(2).png">
          <div class="title">
            <b>Calculadora de orçamentos</b>
          </div>
        </div>
      </div>

      <div class="grid col-lg-12">
        <div class="panel col-lg-12">
          <h5>Dados da Proposta</h5>

          <div class="row g-3">
            <div class="col-md-7">
              <label class="form-label">Nome do Projecto</label>
              <input id="projectName" class="form-control" placeholder="Ex: Implementação 2smart HR" value="Projeto para cliente">
            </div>
            <div class="col-md-5">
              <label class="form-label">Referência</label>
              <input id="refCode" class="form-control" placeholder="Ex: 4989487984" value="">
            </div>

            <div class="col-md-6">
              <label class="form-label">Cliente</label>
              <input id="clientName" class="form-control" placeholder="Nome do cliente" value="">
            </div>
            <div class="col-md-6">
              <label class="form-label">Validade da proposta</label>
              <input id="validity" class="form-control" placeholder="Ex: 30 dias" value="30 dias">
            </div>

            <div class="col-md-4">
              <label class="form-label">Comercial</label>
              <input id="salesName" class="form-control" placeholder="Nome do comercial" value="Miguel Cunha">
            </div>
            <div class="col-md-4">
              <label class="form-label">Função</label>
              <input id="salesRole" class="form-control" placeholder="Ex: Account Manager" value="Account Manager">
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input id="salesEmail" class="form-control" placeholder="email@2smart.pt" value="sales@2smart.pt">
            </div>
          </div>

          <hr class="my-4">

          <div class="soft">
            <div class="d-flex flex-wrap gap-3 align-items-center">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleSoftware" checked>
                <label class="form-check-label fw-bold" for="toggleSoftware">Software</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleModules">
                <label class="form-check-label fw-bold" for="toggleModules">Módulos</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleTerminals">
                <label class="form-check-label fw-bold" for="toggleTerminals">Terminais</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleAccessories">
                <label class="form-check-label fw-bold" for="toggleAccessories">Acessórios / Serviços</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleRenting">
                <label class="form-check-label fw-bold" for="toggleRenting">Renting</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleTechAdvisory">
                <label class="form-check-label fw-bold" for="toggleTechAdvisory">Assessoria Técnica</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleSupport">
                <label class="form-check-label fw-bold" for="toggleSupport">Suporte Técnico</label>
              </div>
            </div>
          </div>

          <div id="secSoftware" class="mt-3">
            <div class="section-head">
              <div class="left"><span class="badge-num">1</span>Software</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addSoftwareRow">
                  <i class="bi bi-plus-lg"></i> Adicionar item
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:42%">Item</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:18%">Tipo</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="softwareBody"></tbody>
              </table>
            </div>
          </div>

          <div id="secModules" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">2</span>Módulos</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addModuleRow">
                  <i class="bi bi-plus-lg"></i> Adicionar módulo
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:42%">Módulo</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:18%">Modelo</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="modulesBody"></tbody>
              </table>
            </div>
          </div>

          <div id="secTerminals" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">3</span>Terminais</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addTerminalRow">
                  <i class="bi bi-plus-lg"></i> Adicionar terminal
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:42%">Terminal</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:18%">Categoria</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="terminalsBody"></tbody>
              </table>
            </div>
          </div>

          <div id="secAccessories" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">4</span>Acessórios / Serviços</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addAccessoryRow">
                  <i class="bi bi-plus-lg"></i> Adicionar item
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:42%">Item</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:18%">Tipo</th>
                    <th style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="accessoriesBody"></tbody>
              </table>
            </div>
          </div>

          <div id="secRenting" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">5</span>Renting</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addRentingRow">
                  <i class="bi bi-plus-lg"></i> Adicionar item
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:40%">Serviço</th>
                    <th style="width:18%">Colaboradores</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:16%">Tipo</th>
                    <th style="width:8%"></th>
                  </tr>
                </thead>
                <tbody id="rentingBody"></tbody>
              </table>
            </div>
          </div>

          <div id="secTechAdvisory" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">6</span>Assessoria Técnica</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addTechRow">
                  <i class="bi bi-plus-lg"></i> Adicionar pacote
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:38%">Pacote</th>
                    <th style="width:14%">Horas</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:8%"></th>
                  </tr>
                </thead>
                <tbody id="techBody"></tbody>
              </table>
            </div>
          </div>

          <div id="secSupport" class="mt-4" style="display:none">
            <div class="section-head">
              <div class="left"><span class="badge-num">7</span>Suporte Técnico</div>
              <div class="mini-actions">
                <button class="btn btn-sm btn-ghost" type="button" id="addSupportRow">
                  <i class="bi bi-plus-lg"></i> Adicionar pack
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table-lite">
                <thead>
                  <tr>
                    <th style="width:46%">Pack</th>
                    <th style="width:16%">Inclui</th>
                    <th style="width:12%">Qtd.</th>
                    <th style="width:18%">Valor unitário</th>
                    <th style="width:8%"></th>
                  </tr>
                </thead>
                <tbody id="supportBody"></tbody>
              </table>
            </div>
          </div>

          <hr class="my-4">

          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Observações</label>
              <textarea id="notes" class="form-control" rows="3" placeholder="Notas adicionais (opcional)"></textarea>
            </div>
          </div>

          <br>

          <div class="totals-card mb-3">
            <div class="totals-row">
              <div class="k"><i class="bi bi-receipt"></i> Total da proposta</div>
              <div class="v" id="grandTotal">0,00 €</div>
            </div>
            <div class="totals-row">
              <div class="k"><i class="bi bi-arrow-repeat"></i> Subscrição anual</div>
              <div class="v" id="annualTotal">0,00 €</div>
            </div>
            <div class="totals-row">
              <div class="k"><i class="bi bi-calendar3"></i> Subscrição mensal</div>
              <div class="v" id="monthlyTotal">0,00 €</div>
            </div>
            <div class="totals-row">
              <div class="k"><i class="bi bi-box-seam"></i> One-off (instalação/equip.)</div>
              <div class="v" id="oneoffTotal">0,00 €</div>
            </div>
          </div>
        </div>
      </div>

      <div class="sticky-actions">
        <div class="d-flex gap-2 flex-wrap align-items-center">
          <div class="loader" id="loader">
            <span class="spinner"></span>
            <span>A gerar PDF…</span>
          </div>
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-ghost" type="button" id="previewBtn">
            <i class="bi bi-eye"></i> Pré-visualizar PDF
          </button>
          <button class="btn btn-primary" type="button" id="exportBtn">
            <i class="bi bi-filetype-pdf"></i> Exportar PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="pdfRenderHost"><div id="pdfRoot"></div></div>

  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-preview-narrow">
      <div class="modal-content" style="border-radius:18px;">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Pré-visualização (HTML do PDF)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="previewArea" class="border rounded-4 p-3" style="background:#fff;"></div>
        </div>
      </div>
    </div>
  </div>
 
<script>
  const eur = (n) => {
    const v = Number(n || 0);
    return v.toLocaleString("pt-PT", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
  };

  const num = (v) => {
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(",", ".").replace(/[^\d.\-]/g, "");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const $ = (id) => document.getElementById(id);
  function show(el, on){ el.style.display = on ? "" : "none"; }

  const CATALOG = {
    software: [
      { label: "2smart HR Cloud — Licença (1º Ano)", price: 6.60, type: "mensal_colab", hint: "€ / colaborador (mês)" },
      { label: "2smart HR Cloud — Subscrição Anual", price: 4.50, type: "anual_colab", hint: "€ / colaborador / ano" }
    ],
    modules: [
      { label: "Geolocalização & Geofencing", price: 1.00, model: "mensal_colab", hint: "€ / mês por colaborador" },
      { label: "Integração com ERP", price: 0.65, model: "mensal_colab", hint: "€ / mês por colaborador" },
      { label: "Automatização de Processos e Envio de Relatórios", price: 8.00, model: "mensal", hint: "€ / mês" }
    ],
    terminals: [
      { label: "2S-M6PRO - Terminal 2Smart HR Rec. Facial + imp. Digital + RFID 125KHz LCD 4.3″ Luz Visível Wifi", price: 318.00, cat: "Acessos + Assiduidade" },
      { label: "2S-M5PRO -  Terminal 2Smart HR Rec. Facial + imp. Digital + RFID 125KHz LCD 2.8″ Luz Visível Wifi", price: 261.00, cat: "Acessos + Assiduidade" },
      { label: "2S-M2PRO - Terminal 2Smart HR Rec. Facial + imp. Digital + RFID 125KHz LCD 2.8″ Luz Visível Wifi", price: 195.00, cat: "Acessos + Assiduidade" },
      { label: "TA500 — Terminal Controlo Assiduidade (Impressão Digital)", price: 269.00, cat: "Assiduidade" }
    ],
    accessories: [
      { label: "Instalação (serviço)", price: 220.00, type:"oneoff", hint:"€" },
      { label: "Configuração/Parametrização", price: 180.00, type:"oneoff", hint:"€" },
      { label: "Deslocação (até 30 km)", price: 85.00, type:"oneoff", hint:"€" }
    ],
    renting: [
      { label: "Renting (Instalação, Implementação, e formação remota)", price: 400.00, base: "empresa" },
      { label: "Licença", price: 1.50, base: "colaborador" }
    ],
    tech: [
      { label: "Implementação e formação remota — até 50 colaboradores", hours: 4, price: 145.00 },
      { label: "Implementação e formação  remota — até 120 colaboradores", hours: 5, price: 160.00 }
    ],
    support: [
      { label: "2SMART_SERVICE_5", includes: "5h / ano", price: 200.00 },
      { label: "2SMART_SERVICE_10", includes: "10h / ano", price: 400.00 }
    ]
  };

  const defaultRentingRow = () => ({
    id: uid(),
    label: "Renting  (Instalação, Implementação, e formação remota)",
    unit: 400.00,
    collabs: 0,
    kind: "anual"
  });

  const state = {
    software: [],
    modules: [],
    terminals: [],
    accessories: [],
    tech: [],
    support: [],
    renting: [ defaultRentingRow() ]
  };

  setTimeout(() => {
    const p = document?.querySelector("#refCode");
    if(p) p.value = "PR2S-" + (Math.random(4,8)*Math.random(8,2)*3).toString().split(".")[1];
  }, 1200);

  const PDF = window.__PDF_PRO__ || (window.__PDF_PRO__ = {});
  PDF.ensureHost = PDF.ensureHost || function(){
    let host = document.getElementById("pdfRenderHost");
    if(!host){
      host = document.createElement("div");
      host.id = "pdfRenderHost";
      document.body.appendChild(host);
    }
    return host;
  };
  PDF.waitImages = PDF.waitImages || function(root){
    const imgs = Array.from(root.querySelectorAll("img"));
    return Promise.all(imgs.map(img => new Promise(resolve => {
      if(img.complete && img.naturalWidth > 0) return resolve();
      const done = () => resolve();
      img.addEventListener("load", done, { once:true });
      img.addEventListener("error", done, { once:true });
    })));
  };
  PDF.toDataURL = PDF.toDataURL || async function(url){
    const res = await fetch(url, { mode: "cors", cache: "no-cache" });
    const blob = await res.blob();
    return await new Promise((resolve) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.readAsDataURL(blob);
    });
  };
  PDF.inlineImages = PDF.inlineImages || async function(root){
    const imgs = Array.from(root.querySelectorAll("img"));
    for(const img of imgs){
      const src = img.getAttribute("src") || "";
      if(!src || src.startsWith("data:")) continue;
      try{
        const data = await PDF.toDataURL(src);
        img.setAttribute("src", data);
      }catch(e){}
    }
  };

  const toggles = [
    ["toggleSoftware", "secSoftware", "software"],
    ["toggleModules", "secModules", "modules"],
    ["toggleTerminals", "secTerminals", "terminals"],
    ["toggleAccessories", "secAccessories", "accessories"],
    ["toggleRenting", "secRenting", "renting"],
    ["toggleTechAdvisory", "secTechAdvisory", "tech"],
    ["toggleSupport", "secSupport", "support"]
  ];

  function clearSection(key){
    if(key === "renting"){
      state.renting = [ defaultRentingRow() ];
    } else {
      state[key] = [];
    }
  }

  toggles.forEach(([t, s, key]) => {
    $(t).addEventListener("change", () => {
      const on = $(t).checked;
      show($(s), on);
      if(!on){
        clearSection(key);
        render();
      } else {
        if(key === "renting" && (!state.renting || state.renting.length === 0)){
          state.renting = [ defaultRentingRow() ];
          render();
        }
        recalcTotals();
      }
    });
  });

  function buildSelect(options, selectedLabel){
    const sel = document.createElement("select");
    sel.className = "form-select form-select-sm";
    options.forEach(o => {
      const opt = document.createElement("option");
      opt.value = o.label;
      opt.textContent = o.label;
      if (selectedLabel && selectedLabel === o.label) opt.selected = true;
      sel.appendChild(opt);
    });
    return sel;
  }

  function buildInput(value, placeholder, min=0, step="1"){
    const inp = document.createElement("input");
    inp.className = "form-control form-control-sm";
    inp.value = value ?? "";
    inp.placeholder = placeholder || "";
    inp.inputMode = "decimal";
    inp.min = min;
    inp.step = step;
    return inp;
  }

  function buildQty(value=1){
    const inp = buildInput(value, "1", 0, "1");
    inp.type = "number";
    return inp;
  }

  function buildMoney(value){
    const inp = buildInput(value, "0,00", 0, "0.01");
    inp.type = "number";
    inp.step = "0.01";
    return inp;
  }

  function addRow(section, row){
    state[section].push(row);
    render();
  }

  function removeRow(section, id){
    state[section] = state[section].filter(r => r.id !== id);
    render();
  }

  function render(){
    renderSoftware();
    renderModules();
    renderTerminals();
    renderAccessories();
    renderRenting();
    renderTech();
    renderSupport();
    recalcTotals();
  }

  function renderSoftware(){
    const tbody = $("softwareBody");
    tbody.innerHTML = "";
    state.software.forEach(r => {
      const tr = document.createElement("tr");

      const tdItem = document.createElement("td");
      const sel = buildSelect(CATALOG.software, r.label);
      tdItem.appendChild(sel);

      const hint = document.createElement("div");
      hint.className = "muted";
      hint.textContent = (CATALOG.software.find(x => x.label === r.label)?.hint) || "";
      tdItem.appendChild(hint);

      const tdQty = document.createElement("td");
      const qty = buildQty(r.qty);
      tdQty.appendChild(qty);

      const tdUnit = document.createElement("td");
      const unit = buildMoney(r.unit);
      tdUnit.appendChild(unit);

      const tdType = document.createElement("td");
      const typeSel = document.createElement("select");
      typeSel.className = "form-select form-select-sm";
      [
        {v:"anual", t:"Anual"},
        {v:"mensal", t:"Mensal"},
        {v:"oneoff", t:"One-off"}
      ].forEach(o=>{
        const opt=document.createElement("option");
        opt.value=o.v; opt.textContent=o.t;
        if (r.kind===o.v) opt.selected=true;
        typeSel.appendChild(opt);
      });
      tdType.appendChild(typeSel);

      const tdDel = document.createElement("td");
      tdDel.className = "text-end";
      const del = document.createElement("button");
      del.className = "btn btn-sm btn-outline-danger";
      del.type = "button";
      del.innerHTML = '<i class="bi bi-trash"></i>';
      tdDel.appendChild(del);

      sel.addEventListener("change", () => {
        r.label = sel.value;
        const found = CATALOG.software.find(x => x.label === r.label);
        if(found){
          r.unit = found.price;
          r.kind = found.type?.startsWith("anual") ? "anual" : (found.type?.startsWith("mensal") ? "mensal" : "oneoff");
        }
        render();
      });

      qty.addEventListener("input", ()=>{ r.qty = num(qty.value); recalcTotals(); });
      unit.addEventListener("input", ()=>{ r.unit = num(unit.value); recalcTotals(); });
      typeSel.addEventListener("change", ()=>{ r.kind = typeSel.value; recalcTotals(); });

      del.addEventListener("click", ()=> removeRow("software", r.id));

      tr.append(tdItem, tdQty, tdUnit, tdType, tdDel);
      tbody.appendChild(tr);
    });
  }

  function renderModules(){
    const tbody = $("modulesBody");
    tbody.innerHTML = "";
    state.modules.forEach(r => {
      const tr = document.createElement("tr");

      const tdItem = document.createElement("td");
      const sel = buildSelect(CATALOG.modules, r.label);
      tdItem.appendChild(sel);
      const hint = document.createElement("div");
      hint.className = "muted";
      hint.textContent = (CATALOG.modules.find(x => x.label === r.label)?.hint) || "";
      tdItem.appendChild(hint);

      const tdQty = document.createElement("td");
      const qty = buildQty(r.qty);
      tdQty.appendChild(qty);

      const tdUnit = document.createElement("td");
      const unit = buildMoney(r.unit);
      tdUnit.appendChild(unit);

      const tdModel = document.createElement("td");
      const modelSel = document.createElement("select");
      modelSel.className="form-select form-select-sm";
      [
        {v:"oneoff", t:"Disponibilização"},
        {v:"anual", t:"Impacto anual"}
      ].forEach(o=>{
        const opt=document.createElement("option");
        opt.value=o.v; opt.textContent=o.t;
        if (r.model===o.v) opt.selected=true;
        modelSel.appendChild(opt);
      });
      tdModel.appendChild(modelSel);

      const tdDel = document.createElement("td");
      tdDel.className="text-end";
      const del = document.createElement("button");
      del.className="btn btn-sm btn-outline-danger";
      del.type="button";
      del.innerHTML='<i class="bi bi-trash"></i>';
      tdDel.appendChild(del);

      sel.addEventListener("change", () => {
        r.label = sel.value;
        const found = CATALOG.modules.find(x => x.label === r.label);
        if(found) r.unit = found.price;
        render();
      });

      qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
      unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
      modelSel.addEventListener("change", ()=>{ r.model=modelSel.value; recalcTotals(); });
      del.addEventListener("click", ()=> removeRow("modules", r.id));

      tr.append(tdItem, tdQty, tdUnit, tdModel, tdDel);
      tbody.appendChild(tr);
    });
  }

  function renderTerminals(){
    const tbody = $("terminalsBody");
    tbody.innerHTML = "";
    state.terminals.forEach(r => {
      const tr = document.createElement("tr");

      const tdItem = document.createElement("td");
      const sel = buildSelect(CATALOG.terminals, r.label);
      tdItem.appendChild(sel);

      const tdQty = document.createElement("td");
      const qty = buildQty(r.qty);
      tdQty.appendChild(qty);

      const tdUnit = document.createElement("td");
      const unit = buildMoney(r.unit);
      tdUnit.appendChild(unit);

      const tdCat = document.createElement("td");
      tdCat.textContent = r.cat || "—";
      tdCat.style.fontWeight = "800";
      tdCat.style.color = "#0b2e7a";

      const tdDel = document.createElement("td");
      tdDel.className="text-end";
      const del = document.createElement("button");
      del.className="btn btn-sm btn-outline-danger";
      del.type="button";
      del.innerHTML='<i class="bi bi-trash"></i>';
      tdDel.appendChild(del);

      sel.addEventListener("change", () => {
        r.label = sel.value;
        const found = CATALOG.terminals.find(x => x.label === r.label);
        if(found){
          r.unit = found.price;
          r.cat = found.cat;
        }
        render();
      });

      qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
      unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
      del.addEventListener("click", ()=> removeRow("terminals", r.id));

      tr.append(tdItem, tdQty, tdUnit, tdCat, tdDel);
      tbody.appendChild(tr);
    });
  }

  function renderAccessories(){
    const tbody = $("accessoriesBody");
    tbody.innerHTML = "";
    state.accessories.forEach(r => {
      const tr = document.createElement("tr");

      const tdItem = document.createElement("td");
      const sel = buildSelect(CATALOG.accessories, r.label);
      tdItem.appendChild(sel);
      const hint = document.createElement("div");
      hint.className="muted";
      hint.textContent = (CATALOG.accessories.find(x=>x.label===r.label)?.hint) || "";
      tdItem.appendChild(hint);

      const tdQty = document.createElement("td");
      const qty = buildQty(r.qty);
      tdQty.appendChild(qty);

      const tdUnit = document.createElement("td");
      const unit = buildMoney(r.unit);
      tdUnit.appendChild(unit);

      const tdType = document.createElement("td");
      const typeSel = document.createElement("select");
      typeSel.className="form-select form-select-sm";
      [
        {v:"oneoff", t:"One-off"},
        {v:"anual", t:"Anual"}
      ].forEach(o=>{
        const opt=document.createElement("option");
        opt.value=o.v; opt.textContent=o.t;
        if (r.kind===o.v) opt.selected=true;
        typeSel.appendChild(opt);
      });
      tdType.appendChild(typeSel);

      const tdDel = document.createElement("td");
      tdDel.className="text-end";
      const del = document.createElement("button");
      del.className="btn btn-sm btn-outline-danger";
      del.type="button";
      del.innerHTML='<i class="bi bi-trash"></i>';
      tdDel.appendChild(del);

      sel.addEventListener("change", ()=>{
        r.label = sel.value;
        const found = CATALOG.accessories.find(x=>x.label===r.label);
        if(found) r.unit = found.price;
        render();
      });

      qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
      unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
      typeSel.addEventListener("change", ()=>{ r.kind=typeSel.value; recalcTotals(); });
      del.addEventListener("click", ()=> removeRow("accessories", r.id));

      tr.append(tdItem, tdQty, tdUnit, tdType, tdDel);
      tbody.appendChild(tr);
    });
  }

  function rentingLineTotal(r){
    const found = CATALOG.renting.find(x => x.label === r.label);
    const base = found?.base || "empresa";
    if(base === "empresa") return 1 * num(r.unit);
    return Math.max(0, Math.floor(num(r.collabs))) * num(r.unit);
  }

  function renderRenting(){
    const tbody = $("rentingBody");
    tbody.innerHTML = "";

    state.renting.forEach(r => {
      const tr = document.createElement("tr");

      const tdItem = document.createElement("td");
      const sel = buildSelect(CATALOG.renting, r.label);
      tdItem.appendChild(sel);

      const tdCollabs = document.createElement("td");
      const collabs = buildQty(r.collabs ?? 0);
      collabs.placeholder = "0";
      tdCollabs.appendChild(collabs);

      const tdUnit = document.createElement("td");
      const unit = buildMoney(r.unit);
      tdUnit.appendChild(unit);

      const tdKind = document.createElement("td");
      const kindSel = document.createElement("select");
      kindSel.className = "form-select form-select-sm";
      [
        {v:"mensal", t:"Mensal"},
        {v:"anual", t:"Anual"},
        {v:"oneoff", t:"One-off"}
      ].forEach(o=>{
        const opt=document.createElement("option");
        opt.value=o.v; opt.textContent=o.t;
        if (r.kind===o.v) opt.selected=true;
        kindSel.appendChild(opt);
      });
      tdKind.appendChild(kindSel);

      const tdDel = document.createElement("td");
      tdDel.className = "text-end";
      const del = document.createElement("button");
      del.className = "btn btn-sm btn-outline-danger";
      del.type = "button";
      del.innerHTML = '<i class="bi bi-trash"></i>';
      tdDel.appendChild(del);

      const applyRules = () => {
        const found = CATALOG.renting.find(x => x.label === r.label);
        const base = found?.base || "empresa";

        if(found){
          r.unit = found.price;
          unit.value = r.unit;
        }

        if(base === "empresa"){
          r.collabs = 0;
          collabs.value = 0;
          tdCollabs.innerHTML = '<span style="font-weight:900;color:#0b2e7a">—</span>';
        } else {
          tdCollabs.innerHTML = "";
          tdCollabs.appendChild(collabs);
        }

        if(r.label === "Licença"){
          kindSel.innerHTML = "";
          [
            {v:"mensal", t:"Mensal"},
            {v:"anual", t:"Anual"}
          ].forEach(o=>{
            const opt=document.createElement("option");
            opt.value=o.v; opt.textContent=o.t;
            kindSel.appendChild(opt);
          });
          if(r.kind !== "mensal" && r.kind !== "anual") r.kind = "mensal";
          kindSel.value = r.kind;
        } else {
          kindSel.innerHTML = "";
          [
            {v:"mensal", t:"Mensal"},
            {v:"anual", t:"Anual"},
            {v:"oneoff", t:"One-off"}
          ].forEach(o=>{
            const opt=document.createElement("option");
            opt.value=o.v; opt.textContent=o.t;
            kindSel.appendChild(opt);
          });
          if(!["mensal","anual","oneoff"].includes(r.kind)) r.kind = "anual";
          kindSel.value = r.kind;
        }
      };

      sel.addEventListener("change", () => {
        r.label = sel.value;
        applyRules();
        recalcTotals();
      });

      collabs.addEventListener("input", ()=>{ r.collabs = Math.max(0, Math.floor(num(collabs.value))); recalcTotals(); });
      unit.addEventListener("input", ()=>{ r.unit = num(unit.value); recalcTotals(); });
      kindSel.addEventListener("change", ()=>{ r.kind = kindSel.value; recalcTotals(); });

      del.addEventListener("click", ()=>{
        if(state.renting.length === 1){
          const d = defaultRentingRow();
          r.label = d.label;
          r.unit = d.unit;
          r.collabs = d.collabs;
          r.kind = d.kind;
          renderRenting();
          recalcTotals();
          return;
        }
        state.renting = state.renting.filter(x => x.id !== r.id);
        render();
      });

      tr.append(tdItem, tdCollabs, tdUnit, tdKind, tdDel);
      tbody.appendChild(tr);

      applyRules();
    });
  }

  function renderTech(){
    const tbody = $("techBody");
    tbody.innerHTML = "";
    state.tech.forEach(r=>{
      const tr=document.createElement("tr");

      const tdPack=document.createElement("td");
      const sel=buildSelect(CATALOG.tech, r.label);
      tdPack.appendChild(sel);

      const tdHours=document.createElement("td");
      const hours=buildInput(r.hours ?? "", "Horas", 0, "1");
      hours.type="number";
      tdHours.appendChild(hours);

      const tdQty=document.createElement("td");
      const qty=buildQty(r.qty);
      tdQty.appendChild(qty);

      const tdUnit=document.createElement("td");
      const unit=buildMoney(r.unit);
      tdUnit.appendChild(unit);

      const tdDel=document.createElement("td");
      tdDel.className="text-end";
      const del=document.createElement("button");
      del.className="btn btn-sm btn-outline-danger";
      del.type="button";
      del.innerHTML='<i class="bi bi-trash"></i>';
      tdDel.appendChild(del);

      sel.addEventListener("change", ()=>{
        r.label=sel.value;
        const found=CATALOG.tech.find(x=>x.label===r.label);
        if(found){
          r.hours = found.hours;
          r.unit = found.price;
        }
        render();
      });

      hours.addEventListener("input", ()=>{ r.hours=num(hours.value); });
      qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
      unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
      del.addEventListener("click", ()=> removeRow("tech", r.id));

      tr.append(tdPack, tdHours, tdQty, tdUnit, tdDel);
      tbody.appendChild(tr);
    });
  }

  function renderSupport(){
    const tbody=$("supportBody");
    tbody.innerHTML="";
    state.support.forEach(r=>{
      const tr=document.createElement("tr");

      const tdPack=document.createElement("td");
      const sel=buildSelect(CATALOG.support, r.label);
      tdPack.appendChild(sel);

      const tdInc=document.createElement("td");
      tdInc.textContent = r.includes || "—";
      tdInc.style.fontWeight = "800";
      tdInc.style.color = "#0b2e7a";

      const tdQty=document.createElement("td");
      const qty=buildQty(r.qty);
      tdQty.appendChild(qty);

      const tdUnit=document.createElement("td");
      const unit=buildMoney(r.unit);
      tdUnit.appendChild(unit);

      const tdDel=document.createElement("td");
      tdDel.className="text-end";
      const del=document.createElement("button");
      del.className="btn btn-sm btn-outline-danger";
      del.type="button";
      del.innerHTML='<i class="bi bi-trash"></i>';
      tdDel.appendChild(del);

      sel.addEventListener("change", ()=>{
        r.label=sel.value;
        const found=CATALOG.support.find(x=>x.label===r.label);
        if(found){
          r.includes = found.includes;
          r.unit = found.price;
        }
        render();
      });

      qty.addEventListener("input", ()=>{ r.qty=num(qty.value); recalcTotals(); });
      unit.addEventListener("input", ()=>{ r.unit=num(unit.value); recalcTotals(); });
      del.addEventListener("click", ()=> removeRow("support", r.id));

      tr.append(tdPack, tdInc, tdQty, tdUnit, tdDel);
      tbody.appendChild(tr);
    });
  }

  function annualToYearIfNeeded(kind, line){
    return (kind === "anual") ? (line * 12) : line;
  }

  function recalcTotals(){
    let annual = 0;
    let monthly = 0;
    let oneoff = 0;

    if ($("toggleSoftware").checked){
      state.software.forEach(r=>{
        let line = num(r.qty) * num(r.unit);
        if (r.kind === "anual") line *= 12;
        if (r.kind === "anual") annual += line;
        else if (r.kind === "mensal") monthly += line;
        else oneoff += line;
      });
    }

    if ($("toggleModules").checked){
      state.modules.forEach(r=>{
        let line = num(r.qty) * num(r.unit);
        if (r.model === "anual") line *= 12;
        if (r.model === "anual") annual += line;
        else oneoff += line;
      });
    }

    if ($("toggleTerminals").checked){
      state.terminals.forEach(r=>{ oneoff += num(r.qty) * num(r.unit); });
    }

    if ($("toggleAccessories").checked){
      state.accessories.forEach(r=>{
        let line = num(r.qty) * num(r.unit);
        if (r.kind === "anual") line *= 12;
        if (r.kind === "anual") annual += line;
        else oneoff += line;
      });
    }

    if ($("toggleTechAdvisory").checked){
      state.tech.forEach(r=>{ oneoff += num(r.qty) * num(r.unit); });
    }

    if ($("toggleSupport").checked){
      state.support.forEach(r=>{ oneoff += num(r.qty) * num(r.unit); });
    }

    if ($("toggleRenting").checked){
      state.renting.forEach(r=>{
        let line = rentingLineTotal(r);
        if(r.kind === "anual") line *= 12;
        if(r.kind === "mensal") monthly += line;
        else if(r.kind === "anual") annual += line;
        else oneoff += line;
      });
    }

    const grand = annual + monthly + oneoff;

    $("annualTotal").textContent = eur(annual);
    $("monthlyTotal").textContent = eur(monthly);
    $("oneoffTotal").textContent = eur(oneoff);
    $("grandTotal").textContent = eur(grand);
  }

  function addDefaultRow(section, catalog, label){
    const found = catalog.find(x=>x.label===label) || catalog[0];
    if (!found) return;

    if (section === "software"){
      addRow("software", { id: uid(), label: found.label, qty: 1, unit: found.price, kind: (found.type?.startsWith("anual") ? "anual" : (found.type?.startsWith("mensal") ? "mensal" : "oneoff")) });
    } else if (section === "modules"){
      addRow("modules", { id: uid(), label: found.label, qty: 1, unit: found.price, model: "oneoff" });
    } else if (section === "terminals"){
      addRow("terminals", { id: uid(), label: found.label, qty: 1, unit: found.price, cat: found.cat });
    } else if (section === "accessories"){
      addRow("accessories", { id: uid(), label: found.label, qty: 1, unit: found.price, kind: "oneoff" });
    } else if (section === "tech"){
      addRow("tech", { id: uid(), label: found.label, hours: found.hours, qty: 1, unit: found.price });
    } else if (section === "support"){
      addRow("support", { id: uid(), label: found.label, includes: found.includes, qty: 1, unit: found.price });
    }
  }

  function addRentingRow(){
    const found = CATALOG.renting[0];
    addRow("renting", { id: uid(), label: found.label, unit: found.price, collabs: 0, kind: "anual" });
  }

  $("addSoftwareRow").addEventListener("click", ()=> addDefaultRow("software", CATALOG.software));
  $("addModuleRow").addEventListener("click", ()=> addDefaultRow("modules", CATALOG.modules));
  $("addTerminalRow").addEventListener("click", ()=> addDefaultRow("terminals", CATALOG.terminals));
  $("addAccessoryRow").addEventListener("click", ()=> addDefaultRow("accessories", CATALOG.accessories));
  $("addTechRow").addEventListener("click", ()=> addDefaultRow("tech", CATALOG.tech));
  $("addSupportRow").addEventListener("click", ()=> addDefaultRow("support", CATALOG.support));
  $("addRentingRow").addEventListener("click", addRentingRow);

  function sectionToPDF(title, rows, options={}){
    const { columns } = options;
    if (!rows || rows.length === 0) return "";
    const thead = columns.map(c => `<th>${c}</th>`).join("");
    const tbody = rows.map(r => `<tr>${r.map(cell=> `<td>${cell}</td>`).join("")}</tr>`).join("");
    return `
      <div class="pdf-section-title">${title}</div>
      <table class="pdf-table">
        <thead><tr>${thead}</tr></thead>
        <tbody>${tbody}</tbody>
      </table>
    `;
  }

  function buildPDFHtml(){
    const Url = "https://ik.imagekit.io/fsobpyaa5i/capa_smart.png?updatedAt=1769508815425";
    const footerUrl = "https://ik.imagekit.io/fsobpyaa5i/Group%2030469%20(3).png";
    const logoUrl = "https://ik.imagekit.io/fsobpyaa5i/Ativo%208%20(2).png";

    const projectName = $("projectName").value.trim() || "Proposta Comercial";
    const refCode = $("refCode").value.trim() || "";
    const clientName = $("clientName").value.trim() || "";
    const validity = $("validity").value.trim() || "";
    const salesName = $("salesName").value.trim() || "";
    const salesRole = $("salesRole").value.trim() || "";
    const salesEmail = $("salesEmail").value.trim() || "";
    const notes = $("notes").value.trim() || "";
    const genDate = new Date().toLocaleDateString("pt-PT");

    recalcTotals();
    const annual = $("annualTotal").textContent;
    const monthly = $("monthlyTotal").textContent;
    const oneoff = $("oneoffTotal").textContent;
    const grand = $("grandTotal").textContent;

    const softwareRows = $("toggleSoftware").checked ? state.software.map(r=>{
      let line = num(r.qty) * num(r.unit);
      const kind = r.kind === "anual" ? "Anual" : (r.kind === "mensal" ? "Mensal" : "One-off");
      if (r.kind === "anual") line *= 12;
      return [
        `<b>${escapeHtml(r.label)}</b>`,
        `${escapeHtml(String(r.qty || 0))}`,
        `${eur(r.unit)}`,
        `${kind}`,
        `<b>${eur(line)}</b>`
      ];
    }) : [];

    const moduleRows = $("toggleModules").checked ? state.modules.map(r=>{
      let line = num(r.qty) * num(r.unit);
      const model = r.model === "anual" ? "Anual" : "One-off";
      if (r.model === "anual") line *= 12;
      return [
        `<b>${escapeHtml(r.label)}</b>`,
        `${escapeHtml(String(r.qty || 0))}`,
        `${eur(r.unit)}`,
        `${model}`,
        `<b>${eur(line)}</b>`
      ];
    }) : [];

    const terminalRows = $("toggleTerminals").checked ? state.terminals.map(r=>{
      const line = num(r.qty) * num(r.unit);
      return [
        `<b>${escapeHtml(r.label)}</b><div style="font-size:10px;color:#5a6c87;font-weight:700;margin-top:2px">${escapeHtml(r.cat||"")}</div>`,
        `${escapeHtml(String(r.qty || 0))}`,
        `${eur(r.unit)}`,
        `<b>${eur(line)}</b>`
      ];
    }) : [];

    const accessoryRows = $("toggleAccessories").checked ? state.accessories.map(r=>{
      let line = num(r.qty) * num(r.unit);
      const kind = r.kind === "anual" ? "Anual" : "One-off";
      if (r.kind === "anual") line *= 12;
      return [
        `<b>${escapeHtml(r.label)}</b>`,
        `${escapeHtml(String(r.qty || 0))}`,
        `${eur(r.unit)}`,
        `${kind}`,
        `<b>${eur(line)}</b>`
      ];
    }) : [];

    const rentingRows = (() => {
      if (!$("toggleRenting").checked) return [];
      const rows = state.renting
        .map(r => {
          let total = rentingLineTotal(r);
          if(total <= 0) return null;
          const tipo = r.kind === "mensal" ? "Mensal" : (r.kind === "anual" ? "Anual" : "One-off");
          if(r.kind === "anual") total *= 12;
          return [
            `<b>${escapeHtml(r.label)}</b>`,
            `${tipo}`,
            `<b>${eur(total)}</b>`
          ];
        })
        .filter(Boolean);
      return rows;
    })();

    const techRows = $("toggleTechAdvisory").checked ? state.tech.map(r=>{
      const line = num(r.qty) * num(r.unit);
      const hours = (num(r.hours) > 0) ? `${num(r.hours)}h` : "Sob consulta";
      return [
        `<b>${escapeHtml(r.label)}</b>`,
        `${hours}`,
        `${escapeHtml(String(r.qty || 0))}`,
        `${eur(r.unit)}`,
        `<b>${eur(line)}</b>`
      ];
    }) : [];

    const supportRows = $("toggleSupport").checked ? state.support.map(r=>{
      const line = num(r.qty) * num(r.unit);
      return [
        `<b>${escapeHtml(r.label)}</b>`,
        `${escapeHtml(r.includes || "")}`,
        `${escapeHtml(String(r.qty || 0))}`,
        `${eur(r.unit)}`,
        `<b>${eur(line)}</b>`
      ];
    }) : [];

    const showSoftware = $("toggleSoftware").checked && softwareRows.length;
    const showModules = $("toggleModules").checked && moduleRows.length;
    const showTerminals = $("toggleTerminals").checked && terminalRows.length;
    const showAccessories = $("toggleAccessories").checked && accessoryRows.length;
    const showRenting = $("toggleRenting").checked && rentingRows.length;
    const showTech = $("toggleTechAdvisory").checked && techRows.length;
    const showSupport = $("toggleSupport").checked && supportRows.length;

    return `
      <div class="pdf-">
        <img src="${escapeAttr(Url)}" alt="Capa">
      </div>

      <div class="pdf-flow">
        <div class="pdf-header">
          <div class="meta">
            <h2>Proposta Comercial</h2>
            <p style="margin-top:4px">Documento gerado em <b>${escapeHtml(genDate)}</b></p>
          </div>
          <img class="logo" src="${escapeAttr(logoUrl)}" alt="2smart">
        </div>

        <div class="pdf-meta">
          <div class="pdf-meta-grid">
            <div class="pdf-meta-item"><b>Cliente</b>${clientName ? `<span><b style="all:unset;font-weight:800;color:#0d1b2a">${escapeHtml(clientName)}</b></span>` : "—"}</div>
            <div class="pdf-meta-item"><b>Projeto</b>${projectName ? `<span><b style="all:unset;font-weight:800;color:#0d1b2a">${escapeHtml(projectName)}</b></span>` : "—"}</div>
            <div class="pdf-meta-item"><b>Referência</b>${refCode ? escapeHtml(refCode) : "—"}</div>
            <div class="pdf-meta-item"><b>Validade</b>${validity ? escapeHtml(validity) : "—"}</div>
            <div class="pdf-meta-item"><b>Comercial</b>${salesName ? escapeHtml(salesName) : "—"}${salesRole ? ` <span style="color:#5a6c87;font-weight:700">(${escapeHtml(salesRole)})</span>` : ""}</div>
            <div class="pdf-meta-item"><b>Email</b>${salesEmail ? escapeHtml(salesEmail) : "—"}</div>
          </div>
        </div>

        <div class="pdf-block">
          ${showSoftware ? sectionToPDF("Software", softwareRows, { columns: ["Item","Qtd.","Valor unitário","Tipo","Total"] }) : ""}
          ${showModules ? sectionToPDF("Módulos", moduleRows, { columns: ["Módulo","Qtd.","Valor unitário","Modelo","Total"] }) : ""}
          ${showTerminals ? sectionToPDF("Terminais", terminalRows, { columns: ["Item","Qtd.","Valor unitário","Total"] }) : ""}
          ${showAccessories ? sectionToPDF("Acessórios / Serviços", accessoryRows, { columns: ["Item","Qtd.","Valor unitário","Tipo","Total"] }) : ""}
          ${showRenting ? sectionToPDF("Renting  (Instalação, Implementação, e formação remota)", rentingRows, { columns: ["Serviço","Tipo","Total"] }) : ""}
          ${showTech ? sectionToPDF("Assessoria Técnica", techRows, { columns: ["Pacote","Horas","Qtd.","Valor unitário","Total"] }) : ""}
          ${showSupport ? sectionToPDF("Suporte Técnico", supportRows, { columns: ["Pack","Inclui","Qtd.","Valor unitário","Total"] }) : ""}

          ${notes ? `
            <div class="pdf-section-title">Observações</div>
            <div style="border:1px solid #e8eef7;border-radius:12px;padding:12px;font-size:11px;line-height:1.6;color:#30425e;font-weight:500;background:#fbfdff;">
              ${escapeHtml(notes).replace(/\n/g, "<br>")}
            </div>
          ` : ""}
        </div>

        <div class="pdf-totals">
          <div class="pdf-chip">Total proposta: <span>${escapeHtml(grand)}</span></div>
          <div class="pdf-chip">Subscrição anual: <span>${escapeHtml(annual)}</span></div>
          <div class="pdf-chip">Subscrição mensal: <span>${escapeHtml(monthly)}</span></div>
          <div class="pdf-chip">One-off: <span>${escapeHtml(oneoff)}</span></div>
        </div>

        <div style="height:24px"></div>
      </div>

      <div class="pdf-footer">
        <img src="${escapeAttr(footerUrl)}" alt="Rodapé">
      </div>
    `;
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){ return escapeHtml(str).replaceAll("\n",""); }

  async function ensureImagesLoaded(root){
    const imgs = Array.from(root.querySelectorAll("img"));
    await Promise.all(imgs.map(img => {
      if (img.complete && img.naturalWidth) return Promise.resolve();
      return new Promise((res) => {
        img.onload = () => res();
        img.onerror = () => res();
      });
    }));
  }

  async function renderPdfRoot(){
    const root = $("pdfRoot");
    root.innerHTML = buildPDFHtml();
    await ensureImagesLoaded(root);
    return root;
  }

  $("previewBtn").addEventListener("click", async ()=>{
    const root = await renderPdfRoot();
    $("previewArea").innerHTML = root.innerHTML;
    const modal = new bootstrap.Modal(document.getElementById("previewModal"));
    modal.show();
  });

  async function exportPdfWithMode(qMode){
    const loader = $("loader");
    loader.classList.add("show");

    try{
      window.scrollTo(0,0);

      const root = await renderPdfRoot();
      const host = PDF.ensureHost();

      const originalParent = root.parentElement;
      const originalNext = root.nextElementSibling;
      host.appendChild(root);

      root.style.width = "794px";
      root.style.margin = "0";
      root.style.padding = "0";
      root.style.transform = "none";
      root.style.position = "relative";
      root.style.left = "0";
      root.style.top = "0";

      await PDF.inlineImages(root);
      await PDF.waitImages(root);
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      const refCode = ($("refCode").value.trim() || "sem-codigo");
      const filename = `2Smart HR - proposta comercial - ${sanitizeFile(refCode)}.pdf`;

      const SCALE = (qMode === "light") ? 1.35 : (qMode === "balanced" ? 2.1 : 3.0);
      const JPEG_Q = (qMode === "light") ? 0.72 : (qMode === "balanced" ? 0.86 : 0.995);
      const FOOT_Q = (qMode === "light") ? 0.72 : (qMode === "balanced" ? 0.86 : 0.98);

      const footerEl = root.querySelector(".pdf-footer");
      let footerNext = null;
      let footerParent = null;
      if(footerEl){
        footerParent = footerEl.parentNode;
        footerNext = footerEl.nextSibling;
        footerEl.remove();
      }

      host.style.height = "auto";
      host.style.overflow = "visible";
      root.style.height = "auto";
      root.style.overflow = "visible";

      const dynamicWinH = Math.max(1123, Math.ceil(root.scrollHeight || 0));

      const opt = {
        margin: [0,0,0,0],
        filename,
        image: { type: "jpeg", quality: JPEG_Q },
        html2canvas: {
          scale: SCALE,
          useCORS: true,
          allowTaint: false,
          backgroundColor: "#ffffff",
          windowWidth: 794,
          windowHeight: dynamicWinH,
          scrollX: 0,
          scrollY: 0,
          x: 0,
          y: 0
        },
        jsPDF: { unit: "px", format: [794,1123], orientation: "portrait" },
        pagebreak: { mode: ["css"] }
      };

      const worker = html2pdf().set(opt).from(root).toPdf();
      const pdf = await worker.get("pdf");

      if(footerEl && footerParent){
        if(footerNext) footerParent.insertBefore(footerEl, footerNext);
        else footerParent.appendChild(footerEl);
      }

      if(footerEl){
        await PDF.inlineImages(footerEl);
        await PDF.waitImages(footerEl);

        const canvas = await html2canvas(footerEl, opt.html2canvas);
        const imgData = canvas.toDataURL("image/jpeg", FOOT_Q);
        pdf.addPage([794,1123], "portrait");
        pdf.addImage(imgData, "JPEG", 0, 0, 794, 1123);
      }

      pdf.save(filename);

      if(originalParent){
        if(originalNext) originalParent.insertBefore(root, originalNext);
        else originalParent.appendChild(root);
      }
    } catch(err){
      console.error(err);
      alert("Não foi possível gerar o PDF !");
    } finally{
      loader.classList.remove("show");
    }
  }

  function bindPdfDownloadModal(){
    const btnExport = document.getElementById("exportBtn");
    const btnO = document.getElementById("dlPdfOriginal");
    const btnB = document.getElementById("dlPdfBalanced");
    const btnL = document.getElementById("dlPdfLight");
    const modalEl = document.getElementById("downloadPdfModal");

    if(btnExport && modalEl){
      btnExport.addEventListener("click", ()=>{
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      });
    }

    if(btnO){
      btnO.addEventListener("click", ()=>{
        bootstrap.Modal.getInstance(modalEl)?.hide();
        exportPdfWithMode("original");
      });
    }
    if(btnB){
      btnB.addEventListener("click", ()=>{
        bootstrap.Modal.getInstance(modalEl)?.hide();
        exportPdfWithMode("balanced");
      });
    }
    if(btnL){
      btnL.addEventListener("click", ()=>{
        bootstrap.Modal.getInstance(modalEl)?.hide();
        exportPdfWithMode("light");
      });
    }
  }

  function sanitizeFile(s){
    return String(s || "Proposta")
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w\-]+/g, "_")
      .replace(/_+/g, "_")
      .replace(/^_+|_+$/g, "");
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bindPdfDownloadModal);
  } else {
    bindPdfDownloadModal();
  }

  addRow("software", { id: uid(), label: "2smart HR Cloud — Licença (1º Ano)", qty: 50, unit: 6.60, kind: "mensal" });
  $("refCode").value = "";

  render();
  recalcTotals();
</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <div class="modal fade" id="downloadPdfModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:520px">
      <div class="modal-content" style="border-radius:18px; overflow:hidden">
        <div class="modal-header" style="border:0; padding:16px 18px 8px">
          <h5 class="modal-title" style="font-weight:800">Exportar PDF</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" style="padding:10px 18px 18px">
          <p style="margin:0 0 12px; color:#5a6c87; font-weight:600">Escolhe o tamanho do ficheiro  :</p>
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" id="dlPdfOriginal">Original (alta qualidade)</button>
            <button type="button" class="btn btn-outline-primary" id="dlPdfBalanced">Equilibrado (recomendado)</button>
            <button type="button" class="btn btn-outline-secondary" id="dlPdfLight">Leve (mais compressão)</button>
          </div> 
        </div>
      </div>
    </div>
  </div>

</body>
</html>
